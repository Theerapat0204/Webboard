<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Site-Store | ‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap');
:root{
  --radius: 14px;
  --ring: rgba(255,255,255,.38);
  --glass: rgba(255,255,255,.55);
}
html,body{
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
body{
  /* ‡∏™‡πÅ‡∏ï‡πá‡∏Å‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÅ‡∏ö‡∏ö iOS + ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Sarabun ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ */
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue",
               "Segoe UI", "Sarabun", system-ui, sans-serif;
  letter-spacing: .1px;
}

/* ===== Liquid Glass card ===== */
.liquid{
  background: linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.35));
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border: 1px solid var(--ring);
  border-radius: var(--radius);
  box-shadow:
    0 8px 24px rgba(2,6,23,.10),
    inset 0 1px 0 rgba(255,255,255,.45);
}

/* ‡πÄ‡∏ô‡πâ‡∏ô‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡πÅ‡∏ö‡∏ö iOS */
.ios-input{
  height: 40px;
  border-radius: 12px;
  padding: 0 .625rem;
  border: 1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.8);
  transition: box-shadow .2s ease, border-color .2s ease;
}
.ios-input:focus{
  outline: none;
  border-color: rgba(59,130,246,.45);
  box-shadow: 0 0 0 4px rgba(59,130,246,.12);
}

/* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ô‡∏ß iOS */
.ios-btn{
  height: 40px;
  border-radius: 12px;
  font-weight: 600;
}
/* ===== Area card: ‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏™‡∏ï‡πå‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏´‡∏±‡∏ß‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏° ===== */
.area-card{
  border: 2px solid rgba(2,6,23,.15);
  border-radius: 18px;
  background: #fff;
  box-shadow: 0 10px 24px rgba(2,6,23,.08);
}
.area-head{
  padding:.75rem 1rem;
  border-bottom: 1px solid rgba(255,255,255,.35);
  color:#fff;
  border-top-left-radius:18px;
  border-top-right-radius:18px;
}
.area-chip{
  display:inline-flex; align-items:center; justify-content:center;
  width:28px; height:28px; border-radius:.75rem;
  background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.35);
  color:#fff; font-weight:700;
}
.glass{ background:rgba(255,255,255,.8); backdrop-filter: blur(10px); }
.shimmer{ position:relative; overflow:hidden; background:#f3f4f6; }
.shimmer::after{ content:""; position:absolute; inset:0; transform:translateX(-100%);
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.55),transparent);
  animation:sh 1.1s infinite;
}
@keyframes sh{ 100%{ transform:translateX(100%);} }

/* Sidebar: desktop collapse shifts layout; mobile overlay */
.sidebar{ width:280px; transition:width .25s ease; }
.sidebar.closed{ width:0 !important; border-right:0 !important; overflow:hidden; }
@media (max-width:1024px){
  .sidebar{ position:fixed; left:0; top:0; bottom:0; z-index:40; transform:translateX(-100%); width:280px; transition:transform .25s ease; }
  .sidebar.open{ transform:translateX(0); }
  .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:30; display:none;}
  .overlay.show{ display:block;}
}

/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤ */
table{ table-layout: fixed; width:100%; }
th,td{ word-break:break-word; }

.icon-btn{ display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:.5rem; border:1px solid rgba(15,23,42,.12); background:#fff; }
.icon-btn:hover{ background:#f8fafc; }

/* Modal (scrollable, tidy layout) */
.modal{ position:fixed; inset:0; z-index:50; display:none; pointer-events:none; }
.modal.show{ display:block; pointer-events:auto; }
.modal .backdrop{ position:absolute; inset:0; background:rgba(2,6,23,.45); backdrop-filter:blur(2px); }
.modal .panel{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:16px; }
.modal .card{
  width:100%; max-width:1040px; background:#fff; border-radius:1rem;
  box-shadow:0 20px 48px rgba(2,6,23,.25);
  display:flex; flex-direction:column;
  max-height:90vh; overflow:hidden;
}
.modal .head{
  padding:.875rem 1rem; border-bottom:1px solid #e2e8f0;
  display:flex; align-items:start; justify-content:space-between; gap:1rem;
  position:sticky; top:0; background:#fff; z-index:1;
}
.modal .body{ padding:1rem; overflow-y:auto; }
.modal .foot{ padding:1rem; border-top:1px solid #e2e8f0; position:sticky; bottom:0; background:#fff; z-index:1; }

.meta-row{ display:grid; grid-template-columns:1fr; gap:.25rem; }
@media (min-width: 768px){
  .meta-row{ grid-template-columns: repeat(3, 1fr); }
}
.meta-item{ font-size:13px; color:#334155; }
.meta-item .label{ color:#64748b; margin-right:.25rem; }
.meta-item .text{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

/* Row highlight */
.row-yellow{ background:#FFFBD1; }  /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
.row-red{ background:#FFE5E9; }

/* Row attachments (3-up) */
.row-att{ margin-top:.25rem; }
.row-att .grid3{ display:grid; grid-template-columns:repeat(3,1fr); gap:.25rem; }
.row-att img{ width:100%; height:56px; object-fit:cover; border-radius:.375rem; border:1px solid rgba(15,23,42,.1); }

.row-att .nav{ display:flex; align-items:center; gap:.25rem; margin-top:.25rem; }
.row-att .page{ font-size:11px; color:#475569; }

/* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏Å‡∏£‡∏≠‡∏•‡∏ö‡∏≤‡∏£‡πå‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô */
.no-scrollbar::-webkit-scrollbar{ display:none; }
.no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

/* ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
.ios-input--sm{ height:36px; padding:0 .5rem; font-size:13px; border-radius:10px; }
.ios-btn--sm{ height:36px; padding:0 .75rem; border-radius:10px; font-weight:600; font-size:14px; }

.logo-wide {
  aspect-ratio: 1355 / 392;
  height: 40px;
  width: auto;
  object-fit: contain;
}

/* ===== Spinner Loader ===== */
#loader{
  position: fixed; inset: 0;
  display: none; /* ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™ .show */
  align-items: center; justify-content: center;
  background: rgba(255,255,255,.55);
  backdrop-filter: blur(3px);
  z-index: 50;
}
#loader.show{ display:flex; }
.loader-box{
  background: rgba(255,255,255,.9);
  border-radius: 16px;
  border: 1px solid var(--ring);
  box-shadow: 0 8px 24px rgba(2,6,23,.12);
  padding: 10px 14px;
  display: inline-flex; align-items: center; gap: 10px;
}
.spinner{
  width: 26px; height: 26px; border-radius: 9999px;
  border: 3px solid rgba(2,6,23,.2);
  border-top-color: #0ea5e9;
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg);} }
  </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<body class="bg-gradient-to-br from-emerald-50 via-teal-50 to-sky-50 min-h-screen">

<!-- =================== LOGIN =================== -->
<section id="loginPage" class="min-h-screen flex items-center justify-center p-6">
  <div class="max-w-2xl w-full">
    <div class="glass rounded-3xl border border-white/60 shadow-xl p-6 md:p-8">
      <div class="flex items-center gap-3 mb-6">
        <img src="ESAPlogo.png" class="logo-wide rounded-md shadow" alt="logo">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-slate-900">Executive Store Adopter-Store</h1>
          <p class="text-slate-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-7 gap-3 items-end">
        <div class="md:col-span-3">
          <label class="block text-sm font-medium mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</label>
          <div class="seg grid grid-cols-3 gap-2">
            <div>
              <input type="radio" name="role" id="r_head" value="HEAD" checked>
<label for="r_head"
  class="flex items-center gap-1 px-2 py-1.5 rounded-xl border bg-white hover:bg-emerald-50 transition text-sm">
  <svg class="w-4 h-4 text-emerald-600" viewBox="0 0 24 24" fill="none">
    <path d="M4 7h16M7 7v10m10-10v10M4 17h16" stroke="currentColor" stroke-width="1.5"/>
  </svg>
  <span class="font-semibold">Format Head</span>
</label>
 </div>
            <div>
              <input type="radio" name="role" id="r_vp" value="VP">
              <label for="r_vp" class="flex items-center gap-2 px-3 py-2 rounded-xl border bg-white hover:bg-sky-50 transition text-sm">
                <svg class="w-5 h-5 text-sky-600" viewBox="0 0 24 24" fill="none"><path d="M12 3l3 6 6 .9-4.5 4.1L18 21l-6-3.2L6 21l1.5-7L3 9.9 9 9l3-6Z" stroke="currentColor" stroke-width="1.5"/></svg>
                <span class="font-semibold">VP-DM</span>
              </label>
            </div>
            <div>
              <input type="radio" name="role" id="r_sgm" value="SGM">
              <label for="r_sgm" class="flex items-center gap-2 px-3 py-2 rounded-xl border bg-white hover:bg-violet-50 transition text-sm">
                <svg class="w-5 h-5 text-violet-600" viewBox="0 0 24 24" fill="none"><path d="M12 6a4 4 0 110 8 4 4 0 010-8Zm-7 14a7 7 0 1114 0H5Z" stroke="currentColor" stroke-width="1.5"/></svg>
                <span class="font-semibold">SGM-SM</span>
              </label>
            </div>
          </div>
        </div>

        <div class="md:col-span-3">
          <label class="block text-sm font-medium">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô </label>
          <input id="code" class="w-full border rounded-xl p-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö"/>
        </div>

        <div class="md:col-span-1">
          <button id="btnLogin" class="w-full rounded-xl bg-emerald-600 text-white p-2 font-semibold hover:bg-emerald-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>

      <p id="loginInfo" class="text-sm text-slate-600 mt-3"></p>
    </div>
  </div>
</section>

<!-- =================== APP =================== -->
<section id="appShell" class="hidden">
  <div id="sbOverlay" class="overlay"></div>

  <!-- Success Sheet -->
  <div id="saveSuccess" class="fixed inset-0 hidden z-50">
    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 text-center">
        <div class="mx-auto mb-3 w-14 h-14 rounded-full bg-emerald-100 flex items-center justify-center">
          <svg viewBox="0 0 24 24" class="w-8 h-8 text-emerald-600"><path d="M5 13l4 4L19 7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </div>
        <div class="text-xl font-bold text-slate-900">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
        <div class="text-slate-600 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <span id="succ_count">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        <div class="mt-4">
          <button id="succ_close" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>
  </div>

  <div class="flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar sticky top-0 h-[100dvh] shrink-0 overflow-y-auto bg-white border-r lg:translate-x-0">
      <div class="p-4 flex items-center gap-3 border-b">
        <img src="ESAPlogo.png" class="logo-wide" style="height:32px" alt="logo">
        <div>
          <div class="font-bold text-slate-900">Executive Store Adopter</div>
          <div id="whoami" class="text-xs text-slate-600">‚Äî</div>
        </div>
      </div>
      <nav class="p-2">
        <button data-tab="tabDashboard" class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 font-medium">
          <svg class="w-5 h-5 text-emerald-600" viewBox="0 0 24 24" fill="none"><path d="M3 12h8V3H3v9Zm10 9h8V12h-8v9ZM3 21h8v-7H3v7Zm10-18v7h8V3h-8Z" stroke="currentColor" stroke-width="1.5"/></svg>
          Dashboard
        </button>
        <button data-tab="tabStore" class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 font-medium">
          <svg class="w-5 h-5 text-sky-600" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M6 7v13h12V7M9 3h6" stroke="currentColor" stroke-width="1.5"/></svg>
          ‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤
        </button>
        <button data-tab="tabAdopter" class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 font-medium">
          <svg class="w-5 h-5 text-violet-600" viewBox="0 0 24 24" fill="none"><path d="M12 6a4 4 0 110 8 4 4 0 010-8Zm-7 14a7 7 0 1114 0H5Z" stroke="currentColor" stroke-width="1.5"/></svg>
          ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Adopter
        </button>
        <button id="btnLogout" class="w-full mt-2 flex items-center gap-3 px-3 py-2 rounded-lg bg-rose-50 text-rose-700 hover:bg-rose-100 font-medium">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M16 17l5-5-5-5M21 12H9M13 7V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h6a2 2 0 002-2v-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </button>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 min-h-screen">
      <!-- Top bar -->
      <div class="flex items-center justify-between p-3 bg-white/80 backdrop-blur sticky top-0 z-30 border-b">
        <div class="flex items-center gap-2">
          <button id="btnHamburger" class="p-2 rounded-lg border text-slate-700 hover:bg-slate-50" title="‡πÄ‡∏°‡∏ô‡∏π">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
              <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="font-semibold text-slate-900">Executive Store Adopter</div>
        </div>

        <!-- ‡∏Ç‡∏ß‡∏≤: Export + SaveAll (id ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥) -->
        <div class="flex items-center gap-2">
          <div class="relative">
            <button id="btnExport" class="p-2 rounded-lg border hover:bg-slate-50" title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î/‡∏û‡∏¥‡∏°‡∏û‡πå">
              <svg viewBox="0 0 24 24" class="w-5 h-5">
                <path d="M12 3v12m0 0l-4-4m4 4l4-4M5 21h14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div id="exportMenu" class="hidden absolute right-0 mt-2 w-64 bg-white border rounded-xl shadow-lg z-50">
              <button data-export="print" class="w-full text-left px-3 py-2 hover:bg-slate-50">Print PDF</button>
              <button data-export="csv" class="w-full text-left px-3 py-2 hover:bg-slate-50">CSV</button>
              <button data-export="excel" class="w-full text-left px-3 py-2 hover:bg-slate-50">Excel</button>
<button data-export="import" id="btnImportExcel" class="w-full text-left px-3 py-2 hover:bg-slate-50">
  Import Excel
</button>
<input type="file" id="excelInput" accept=".xlsx" class="hidden" />
            </div>
          </div>
          <button id="btnSaveAllTop" disabled class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white opacity-40">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <section id="tabDashboard" class="p-4">
        <h2 class="text-xl font-bold text-slate-900 mb-3">Dashboard</h2>

        <!-- Summary tiles -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <button id="tileGreen"  class="shimmer h-28 rounded-xl text-left"></button>
          <button id="tileYellow" class="shimmer h-28 rounded-xl text-left"></button>
          <button id="tileRed"    class="shimmer h-28 rounded-xl text-left"></button>
        </div>

        <div class="mt-4">
          <div class="font-semibold text-slate-900 mb-2">Action Status</div>
         <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-4" id="statusTiles">
  <button id="stDone"    class="shimmer h-24 rounded-xl text-left"></button>
  <button id="stInProg"  class="shimmer h-24 rounded-xl text-left"></button>
  <button id="stSent"    class="shimmer h-24 rounded-xl text-left"></button>
  <button id="stNone"    class="shimmer h-24 rounded-xl text-left"></button>
</div>
</div>

        <!-- Round scores by store -->
        <div class="glass border border-white/60 rounded-2xl p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="font-semibold text-slate-900">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 3 ‡∏£‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</div>
            <div class="text-xs text-slate-500" id="roundScoreNote">‡∏Å‡∏£‡∏≠‡∏á/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
          </div>
          <div id="tileRoundWrap" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
        </div>
      </section>

      <!-- STORE -->
      <section id="tabStore" class="hidden">
        <!-- Sticky filters -->
        <div class="sticky top-[56px] z-20 bg-white/70 backdrop-blur border-b">
          <div class="px-3 py-2">
            <div class="liquid p-2">
              <div class="text-[11px] font-semibold text-slate-600 mb-1">Filters</div>

              <div class="flex flex-nowrap items-end gap-2 overflow-x-auto no-scrollbar py-1">
                <label class="block min-w-[120px]">
                  <span class="block text-[11px] text-slate-500 mb-0.5">Round</span>
                  <select id="f_round" class="ios-input ios-input--sm w-full"></select>
                </label>
    <label class="block min-w-[159px]">
  <span class="block text-[10px] text-slate-500 mb-0.5">VP</span>
  <select id="f_vp" class="ios-input ios-input--sm w-full"></select>
</label>
                <label class="block min-w-[180px]">
                  <span class="block text-[11px] text-slate-500 mb-0.5">Area</span>
                  <select id="f_area" class="ios-input ios-input--sm w-full"></select>
                </label>
  
                <label class="block min-w-[200px]">
                  <span class="block text-[11px] text-slate-500 mb-0.5">Topic</span>
                  <select id="f_topic" class="ios-input ios-input--sm w-full"></select>
                </label>

                <label class="block min-w-[140px]">
                  <span class="block text-[11px] text-slate-500 mb-0.5">Result</span>
                  <select id="f_result" class="ios-input ios-input--sm w-full">
                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option>Green</option>
                    <option>Yellow</option>
                    <option>Red</option>
                  </select>
                </label>

                <label class="block min-w-[220px]">
                  <span class="block text-[11px] text-slate-500 mb-0.5">Store</span>
                  <input id="f_store" class="ios-input ios-input--sm w-full" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤">
                </label>

                <div class="flex items-end gap-2 ml-auto pr-1">
                  <button id="btnSearch" class="ios-btn ios-btn--sm bg-sky-600 hover:bg-sky-700 text-white">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                  <button id="btnReset"  class="ios-btn ios-btn--sm border bg-white hover:bg-slate-50">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AREA -> TOPIC -> QUESTION -->
        <div class="p-4 space-y-6" id="areaContainers"></div>
        <div class="px-4 pb-4 text-xs text-slate-500" id="lastSaved">‚Äî</div>
      </section>

      <!-- ADOPTER -->
      <!-- ADOPTER (‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) -->
<section id="tabAdopter" class="p-4">
  <div class="max-w-xl mx-auto bg-white border rounded-2xl shadow-sm p-6 text-center">
    <h2 class="text-xl font-bold text-slate-900 mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Adopter</h2>
    <p class="text-slate-600 mb-4">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>
    <a
      href="https://docs.google.com/forms/d/e/1FAIpQLSe8rJwx-Dzp2m_X0SV2DLkoRJ8eYURTnL_R8KNNg6Qyat9l1Q/viewform" target="_blank" rel="noopener"
      class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-violet-600 text-white hover:bg-violet-700"
    >
      ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Adopter
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
        <path d="M7 17L17 7M10 7h7v7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
      </svg>
    </a>
  </div>
</section>


  <!-- Sticky save (future batch) -->
  <div id="saveBar" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 glass border border-white/60 rounded-2xl shadow-xl px-4 py-3 flex items-center gap-3">
    <div class="text-sm text-slate-700">
      <span id="dirtyCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    </div>
    <button id="btnSaveAll" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl font-semibold">
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </button>
  </div>
</section>

<!-- Loader -->
<div id="loader">
  <div class="loader-box">
    <div class="spinner"></div>
    <div class="text-slate-700 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
  </div>
</div>

<!-- Popup: Comment (read-only) + Action (scrollable) -->
<div id="actionModal" class="modal" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="panel">
    <div class="card">
      <div class="head">
        <div class="space-y-2">
          <div class="text-xs text-slate-500">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="am_round">-</span>)</div>
          <div class="meta-row">
            <div class="meta-item">
              <span class="label">Store:</span>
              <span id="am_meta_store" class="text" title=""></span>
            </div>
            <div class="meta-item">
              <span class="label">Topic:</span>
              <span id="am_meta_topic" class="text" title=""></span>
            </div>
            <div class="meta-item">
              <span class="label">Question:</span>
              <span id="am_meta_question" class="text" title=""></span>
            </div>
          </div>
        </div>
        <button class="icon-btn" id="am_close" title="‡∏õ‡∏¥‡∏î">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>

      <div id="am_body" class="body space-y-5">
        <section>
          <div class="text-xs text-slate-500 mb-1">Comment (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß / ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ)</div>
          <div id="am_comment_ro"
               class="whitespace-pre-wrap rounded-lg border bg-slate-50 p-3 leading-relaxed text-[15px] text-slate-700 min-h-[56px]">‚Äî</div>
        </section>

        <section>
          <div class="text-xs text-slate-500 mb-2">Action</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="block">
              <span class="text-xs text-slate-500">Reason</span>
              <textarea id="am_reason" class="mt-1 w-full border rounded-lg p-2 min-h-[96px]"></textarea>
            </label>
            <label class="block">
              <span class="text-xs text-slate-500">Action</span>
              <textarea id="am_action" class="mt-1 w-full border rounded-lg p-2 min-h-[96px]"></textarea>
            </label>
            <label class="block">
              <span class="text-xs text-slate-500">Assign</span>
              <select id="am_assign" class="mt-1 w-full border rounded-lg p-2"></select>
            </label>
            <div class="grid grid-cols-2 gap-4">
              <label class="block">
                <span class="text-xs text-slate-500">Status</span>
                <select id="am_status" class="mt-1 w-full border rounded-lg p-2">
                  <option>Sent BU</option>
                  <option>In progress</option>
                  <option>Done</option>
                </select>
              </label>
              <label class="block">
                <span class="text-xs text-slate-500">Due</span>
                <input id="am_due" type="date" class="mt-1 w-full border rounded-lg p-2">
              </label>
            </div>
          </div>
        </section>
      </div>

      <div class="foot flex items-center justify-between">
        <div class="text-xs text-slate-500">* ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚Ä¢ Action ‡∏ú‡∏π‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö Question</div>
        <div class="flex items-center gap-2">
          <button id="am_ok" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Summary Modal -->
<div id="summaryModal" class="modal" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="panel">
    <div class="card">
      <div class="head">
        <div>
          <div class="font-semibold text-slate-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Done</div>
          <div id="sm_title" class="text-xs text-slate-500">‚Äî</div>
        </div>
        <button class="icon-btn" id="sm_close" title="‡∏õ‡∏¥‡∏î">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="body">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-50"><tr>
              <th class="px-3 py-2 text-left">Store</th>
              <th class="px-3 py-2 text-left">Area</th>
              <th class="px-3 py-2 text-left">Topic</th>
              <th class="px-3 py-2 text-left">Question</th>
              <th class="px-3 py-2">Answer</th>
              <th class="px-3 py-2">Status</th>
            </tr></thead>
            <tbody id="sm_rows"></tbody>
          </table>
        </div>
      </div>
      <div class="foot flex items-center justify-between">
        <div id="sm_count" class="text-xs text-slate-500">‚Äî</div>
        <button id="sm_ok" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<!-- Status Modal -->
<div id="statusModal" class="modal" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="panel">
    <div class="card">
      <div class="head">
        <div>
          <div class="font-semibold text-slate-900">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏° Action Status</div>
          <div id="stm_title" class="text-xs text-slate-500">‚Äî</div>
        </div>
        <button class="icon-btn" id="stm_close" title="‡∏õ‡∏¥‡∏î">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="body">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-50"><tr>
              <th class="px-3 py-2 text-left">Store</th>
              <th class="px-3 py-2 text-left">Area</th>
              <th class="px-3 py-2 text-left">Question</th>
              <th class="px-3 py-2 text-center">Answer</th>
              <th class="px-3 py-2 text-center">Status</th>
            </tr></thead>
            <tbody id="stm_rows"></tbody>
          </table>
        </div>
      </div>
      <div class="foot flex items-center justify-between">
        <div id="stm_count" class="text-xs text-slate-500">‚Äî</div>
        <button id="stm_ok" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
/* ‡πÉ‡∏™‡πà Web App URL (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec) ‡∏Ç‡∏≠‡∏á GAS ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á Deploy */
const API_BASE = 'https://script.google.com/macros/s/AKfycbytiY6g8a_-P5VVjvVMPj8Mc0hXrN6geTlh7VSd8OJ5OgTC0UsbSnSi-LR_JNXBWgTbwA/exec';

/* ========= STATE ========= */
let TOKEN='', SESSION=null;
let ALL_ITEMS=[];
let REFNO_BY_ROUND={}, CURRENT_REFNO='', CURRENT_ROUND='';
const CHANGES = new Map();

let AM_CTX = null; // {refno,key,topic,question,actionid,round,currentAction,currentComment,storeCode}
const qs  = id=>document.getElementById(id);
const show= (el,on)=> el.classList[on?'remove':'add']('hidden');
const loading = (on)=> qs('loader').classList.toggle('show', !!on);

/* ========= NAV TABS ========= */
const setActiveTab = (tabId)=>{
  ['tabDashboard','tabStore','tabAdopter'].forEach(id=>qs(id).classList.add('hidden'));
  qs(tabId).classList.remove('hidden');
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.classList.toggle('bg-slate-100', btn.dataset.tab===tabId);
  });
};

let LOAD_GEN = 0; // ‡∏£‡∏∏‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Å‡∏±‡∏ô‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏ó‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà)

const CACHE_KEY = ()=> `ss-cache-${SESSION?.role||''}-${SESSION?.code||''}`;
function loadCacheItems() {
  try {
    const raw = sessionStorage.getItem(CACHE_KEY());
    if (!raw) return null;
    const j = JSON.parse(raw);
    return Array.isArray(j.items) ? j.items : null;
  } catch(_) { return null; }
}
function saveCacheItems(items) {
  try { sessionStorage.setItem(CACHE_KEY(), JSON.stringify({ ts: Date.now(), items })); } catch(_){}
}

function getActionId(obj){
  if (!obj || typeof obj !== 'object') return '';
  const keys = ['actionid','action_id','actionId','actionID'];
  for (const k of keys) {
    if (obj[k] != null && obj[k] !== '') return String(obj[k]);
  }
  const nested = obj.action || obj.actions || obj._action || (obj.payload && obj.payload.action) || obj.payload;
  if (Array.isArray(nested) && nested.length) return getActionId(nested[0]);
  if (nested && typeof nested === 'object') {
    for (const k of keys) {
      if (nested[k] != null && nested[k] !== '') return String(nested[k]);
    }
    if (nested.meta && typeof nested.meta === 'object') {
      for (const k of keys) {
        if (nested.meta[k] != null && nested.meta[k] !== '') return String(nested.meta[k]);
      }
    }
  }
  if (obj.payload && (obj.payload.actionId || obj.payload.action_id)) return String(obj.payload.actionId ?? obj.payload.action_id);
  return '';
}

/* ========= API ========= */
// helper: ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÑ‡∏ß‡πâ‡∏ó‡∏≥ backoff)

const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));

async function apiGet(endpoint, params = {}, opt = {}) {
  // timeout ‡∏õ‡∏Å‡∏ï‡∏¥ 120 ‡∏ß‡∏¥ + ‡∏£‡∏µ‡∏ó‡∏£‡∏≤‡∏¢ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å)
  const { timeoutMs = 120000, retries = 2, retryDelayMs = 1500 } = opt;
  const q = new URLSearchParams({ endpoint, token: TOKEN, ...params }).toString();

  let attempt = 0;
  while (true) {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);

    try {
      const res = await fetch(`${API_BASE}?${q}`, {
        method: 'GET',
        cache: 'no-store',
        credentials: 'omit',
        signal: ctrl.signal
      });
      clearTimeout(t);
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status} ${res.statusText} ${text.slice(0,200)}`);
      }
      return await res.json();
    } catch (e) {
      clearTimeout(t);
      if (attempt < retries) {
        attempt++;
        await sleep(retryDelayMs * attempt); // backoff
        continue;
      }
      if (e.name === 'AbortError') {
        throw new Error(`API timeout: ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô ${Math.floor(timeoutMs/1000)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`);
      }
      throw new Error('Network/CORS error (Fail to fetch). ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á');
    }
  }
}


// ‡∏£‡∏±‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
async function runWithConcurrency(tasks, limit = 3) {
  const results = new Array(tasks.length);
  let idx = 0;

  async function worker() {
    while (true) {
      const i = idx++;
      if (i >= tasks.length) break;
      results[i] = await tasks[i]();
    }
  }

  const workers = Array.from({ length: Math.min(limit, tasks.length) }, () => worker());
  await Promise.all(workers);
  return results;
}

// ‡∏ó‡∏≥ batch re-render ‡∏Å‡∏±‡∏ô DOM ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å
function makeRafBatcher(fn, minGap=500){
  let scheduled = false, last = 0;
  return function(){
    const now = Date.now();
    if (scheduled) return;
    const wait = Math.max(0, minGap - (now - last));
    scheduled = true;
    setTimeout(()=> {
      requestAnimationFrame(()=> {
        scheduled = false; last = Date.now(); fn();
      });
    }, wait);
  };
}


// ===== THEME: ‡∏™‡∏µ‡∏´‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ Area (‡∏Ñ‡∏á‡∏ó‡∏µ‡πà/‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠) =====
const AREA_PALETTE = [
  { bg:'#0ea5e9', bd:'#0284c7' }, // sky
  { bg:'#10b981', bd:'#059669' }, // emerald
  { bg:'#f59e0b', bd:'#d97706' }, // amber
  { bg:'#ef4444', bd:'#dc2626' }, // red
  { bg:'#6366f1', bd:'#4f46e5' }, // indigo
  { bg:'#8b5cf6', bd:'#7c3aed' }, // violet
  { bg:'#14b8a6', bd:'#0d9488' }, // teal
  { bg:'#84cc16', bd:'#65a30d' }, // lime
];
function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i)|0; } return Math.abs(h); }
function getAreaTheme(name){
  const p = AREA_PALETTE[ hashCode(String(name||'')) % AREA_PALETTE.length ];
  return p || AREA_PALETTE[0];
}

async function apiPost(endpoint, body = {}, opt = {}) {
  const { timeoutMs = 120000, retries = 2, retryDelayMs = 1500 } = opt;
  const url = `${API_BASE}?endpoint=${encodeURIComponent(endpoint)}&token=${encodeURIComponent(TOKEN)}`;
  let attempt = 0;
  while (true) {
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const form = new URLSearchParams();
      form.append('payload', JSON.stringify(body));
      const res = await fetch(url, { method:'POST', body: form, signal: ctrl.signal, cache:'no-store' });
      clearTimeout(t);
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      return await res.json();
    }catch(e){
      clearTimeout(t);
      if(attempt < retries){ attempt++; await sleep(retryDelayMs*attempt); continue; }
      throw e;
    }
  }
}



/* ========= LOGIN ========= */
qs('btnLogin').onclick = async ()=>{
  const role = [...document.querySelectorAll('input[name=role]')].find(r=>r.checked)?.value || 'HEAD';
  const code = (qs('code').value||'').trim();
  if(!code) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™');

  loading(true);
  try{
    const form = new URLSearchParams({ role, code, wantMeta:'true' });
    const res = await fetch(`${API_BASE}?endpoint=auth_login`, { method:'POST', body: form });
    const json = await res.json();
    if(!json.ok) throw new Error(json.error||'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

    TOKEN = json.data.token;
    SESSION = json.data;
    qs('whoami').textContent = `${role} (${code}) ‚Ä¢ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ${SESSION.scope.refnos.length} refno`;

    await buildRefnoIndex();
    bindRoundOptions();
    

    CURRENT_ROUND = qs('f_round').value;
    CURRENT_REFNO = REFNO_BY_ROUND[CURRENT_ROUND] || SESSION.scope.refnos[0] || '';

    await loadEvaluations();
    await renderDashboard();

    show(qs('loginPage'), false);
    show(qs('appShell'), true);
    setActiveTab('tabStore');
  }catch(ex){
    alert(ex.message);
  }finally{
    loading(false);
  }
};
qs('btnLogout').onclick = ()=> location.reload();

/* ========= ROUND INDEX ========= */
async function buildRefnoIndex(){
  const src = (SESSION.scope && (SESSION.scope.roundBuckets || SESSION.scope.roundIndex)) || {};
  REFNO_BY_ROUND = src;
  if (!Object.keys(REFNO_BY_ROUND).length) {
    const rsp = await apiGet('round_index');
    if (rsp.ok) REFNO_BY_ROUND = rsp.data || {};
  }
}

/* ========= BIND ROUND DROPDOWN ========= */
function bindRoundOptions(){
  const sel = qs('f_round');
  const rounds = Object.keys(REFNO_BY_ROUND);

  if (!rounds.length){
    sel.innerHTML = '<option>-</option>';
    CURRENT_ROUND = '';
    return;
  }

  sel.innerHTML = rounds.map(x=>`<option>${x}</option>`).join('');
  sel.onchange = async ()=>{
    CURRENT_ROUND = sel.value;
    CURRENT_REFNO = REFNO_BY_ROUND[CURRENT_ROUND] || CURRENT_REFNO;
    await loadEvaluations();
    await renderDashboard();
  };
  CURRENT_ROUND = rounds[0];
  sel.value = CURRENT_ROUND;
}
function uniqRefnosFromScope(){
  const out = new Set();
  const m = REFNO_BY_ROUND || {};
  Object.values(m).forEach(v=>{
    if (Array.isArray(v)) v.forEach(x => x && out.add(x));
    else if (v) out.add(v);
  });
  (SESSION?.scope?.refnos || []).forEach(x => x && out.add(x));
  return [...out];
}

async function loadEvaluations(){
  loading(true);
  const gen = ++LOAD_GEN;

  try{
    const refnos = uniqRefnosFromScope();
    if (!refnos.length) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö refno ‡πÉ‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');

    // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    ALL_ITEMS = [];

    const conc = Math.max(3, Math.min(8, (navigator.hardwareConcurrency || 6) - 1));
    const tasks = refnos.map(refno => async ()=> {
      const r = await apiGet('store_evaluation', { refno, page:1, limit:4000 }, { timeoutMs:120000, retries:2, retryDelayMs:2000 });
      if (gen !== LOAD_GEN) return r;
      const items = (r?.ok && r.data?.items) ? r.data.items : [];
      if (items.length){
        ALL_ITEMS.push(...items);
        renderAreaContainers();
        renderActionStatusTiles();
      }
      return r;
    });

    await runWithConcurrency(tasks, conc);

    // (‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö cache ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ALL_ITEMS ‡∏Ñ‡∏∑‡∏≠‡∏ä‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß)
    saveCacheItems(ALL_ITEMS);

    bindAreaTopicOptions();
    renderAreaContainers();
    await renderDashboard();
  }catch(ex){ alert(ex.message); }
  finally{ if (gen === LOAD_GEN) loading(false); }
}




/* ========= DASHBOARD ========= */
async function renderDashboard(){
  // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏µ‡∏ó‡∏∂‡∏ö: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß/‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á/‡πÅ‡∏î‡∏á (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏µ‡∏î‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢)
  const tiles = [
    { id:'tileGreen',  title:'Green',  bg:'bg-emerald-600', text:'text-white',    label:'text-white/90' },
    { id:'tileYellow', title:'Yellow', bg:'bg-yellow-400',  text:'text-black',    label:'text-black/80' },
    { id:'tileRed',    title:'Red',    bg:'bg-rose-600',    text:'text-white',    label:'text-white/90' },
  ];

  const countAll = ALL_ITEMS.length;
  const cnt = (k)=> ALL_ITEMS.filter(x=> String(x.answer||'').toLowerCase().includes(k)).length;
  const data = { all: countAll, green: cnt('green'), yellow: cnt('yellow'), red: cnt('red') };

  tiles.forEach(t=>{
    const el = qs(t.id);
    el.className = `rounded-xl p-4 ${t.text} shadow ${t.bg} text-left border border-black/5`;
    const val = ( t.id==='tileGreen' ? data.green
               : t.id==='tileYellow'? data.yellow
               :                       data.red );
    el.innerHTML = `
      <div class="text-xs ${t.label}">${t.title}</div>
      <div class="text-3xl font-bold mt-1">${val}</div>
    `;
    el.onclick = null;
    el.style.cursor = 'default';
  });

  await renderRoundScoresBox();
  renderActionStatusTiles();
}


function normalizeStatus(s){
  const v = String(s||'').trim().toLowerCase();
  if(!v) return 'none';
  if(v==='done') return 'done';
  if(v==='in progress' || v==='inprogress') return 'inprogress';
  if(v==='sent bu' || v==='sent to bu' || v==='sent') return 'sent';
  return v;
}

function renderActionStatusTiles(){
  // ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Y/R ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  const YR = ALL_ITEMS.filter(it=> /yellow|red/i.test(String(it.answer||'')));

  const stats = { done:0, inprogress:0, sent:0, none:0 };
  YR.forEach(it=>{
    const k = normalizeStatus(it.action?.status);
    if(k in stats) stats[k]++; else stats.none++;
  });

  // ‡∏à‡∏±‡∏î span ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 12 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: 6 + 2 + 2 + 2 = 12
  const tiles = [
    { el:'stNone',   key:'none',       title:'NO ACTION',  value:stats.none,       span:'lg:col-span-6', color:'bg-[#E31E52] text-white',      icon:'‚ìò' },
    { el:'stDone',   key:'done',       title:'DONE',       value:stats.done,       span:'lg:col-span-2', color:'bg-[#0EA472] text-white',      icon:'‚úî' },
    { el:'stInProg', key:'inprogress', title:'IN PROGRESS',value:stats.inprogress, span:'lg:col-span-2', color:'bg-[#0B74C1] text-white',      icon:'üïí' },
    { el:'stSent',   key:'sent',       title:'SENT BU',    value:stats.sent,       span:'lg:col-span-2', color:'bg-[#F2B01E] text-slate-900',  icon:'‚úà' },
  ];

  tiles.forEach(t=>{
    const el = qs(t.el);
    el.className =
      `rounded-2xl ${t.span} p-4 shadow text-left min-h-[120px] ` +
      `flex flex-col justify-center ${t.color}`;
    el.innerHTML =
      `<div class="text-xs opacity-90 tracking-wide mb-1">${t.title}</div>
       <div class="flex items-center gap-3">
         <div class="w-9 h-9 rounded-xl bg-white/15 flex items-center justify-center text-lg">${t.icon}</div>
         <div class="text-3xl font-bold">${t.value}</div>
       </div>
       <div class="text-[11px] mt-1 underline opacity-90">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>`;
    el.onclick = ()=> openStatusModal(t.key, t.title.replace(/\s+/g,' '));
    el.style.cursor = 'pointer';
  });
}



function openStatusModal(key, label){
  const modal = qs('statusModal');
  const tbody = qs('stm_rows');
  const title = qs('stm_title');
  const count = qs('stm_count');

  const rows = ALL_ITEMS.filter(it=>{
    const isYR = /yellow|red/i.test(String(it.answer||''));
    const k = normalizeStatus(it.action?.status);
    return isYR && ((key==='none') ? (k==='none') : (k===key));
  });

  const byArea = new Map();
  rows.forEach(it=>{
    const a = String(it.area||'-');
    if(!byArea.has(a)) byArea.set(a, []);
    byArea.get(a).push(it);
  });

  const areas = Array.from(byArea.keys()).sort((a,b)=>a.localeCompare(b, 'th'));
  title.textContent = `Status: ${label}`;
  tbody.innerHTML = '';

  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="5" class="px-3 py-6 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`;
  }else{
    areas.forEach(area=>{
      const trH = document.createElement('tr');
      trH.innerHTML = `<td colspan="5" class="px-3 py-2 bg-slate-50 text-slate-700 font-semibold">Area: ${area}</td>`;
      tbody.appendChild(trH);

      byArea.get(area).forEach(it=>{
        const tr = document.createElement('tr');
        const store = it.storeName || it.storeCode || '';
        tr.innerHTML = `
          <td class="px-3 py-2">${store}</td>
          <td class="px-3 py-2">${it.area||''}</td>
          <td class="px-3 py-2">${it.question||''}</td>
          <td class="px-3 py-2 text-center">${it.answer||''}</td>
          <td class="px-3 py-2 text-center">${it.action?.status||''}</td>`;
        tbody.appendChild(tr);
      });
    });
  }

  count.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  modal.classList.add('show');
  modal.setAttribute('aria-hidden','false');

  const close = ()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); };
  qs('stm_close').onclick = close;
  qs('stm_ok').onclick = close;
  modal.querySelector('.backdrop').onclick = close;
  document.addEventListener('keydown', function esc(e){
    if(e.key==='Escape'){ close(); document.removeEventListener('keydown', esc); }
  });
}

/* ========= FILTER ========= */
qs('btnSearch').onclick = ()=> renderAreaContainers();
qs('btnReset').onclick = ()=>{
  qs('f_area').value='';
  qs('f_topic').value='';
  qs('f_result').value='';
  qs('f_store').value='';
  renderAreaContainers();
};

const norm = s => String(s||'').trim().toLowerCase();

function uniqueSorted(list){
  const s = new Set();
  list.forEach(v => { const t = String(v??'').trim(); if(t) s.add(t); });
  return Array.from(s).sort((a,b)=> a.localeCompare(b,'th'));
}
function fillSelect(sel, values, placeholder='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'){
  sel.innerHTML = `<option value="">${placeholder}</option>` +
                  values.map(v=>`<option>${v}</option>`).join('');
}
function bindAreaTopicOptions(){
  const selArea  = qs('f_area');
  const selVP    = qs('f_vp');
  const selTopic = qs('f_topic');

  // === ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤ Area ===
  const areas = uniqueSorted(ALL_ITEMS.map(x=>x.area));
  fillSelect(selArea, areas, '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');

  // === ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤ VP (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å region) ===
  const vps = uniqueSorted(ALL_ITEMS.map(x=>x.region)); // <-- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ region ‡πÉ‡∏ô items
  fillSelect(selVP, vps, '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');

  // === ‡πÄ‡∏ï‡∏¥‡∏° Topic ‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö Area (‡πÅ‡∏•‡∏∞ VP ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ===
  const refreshTopics = ()=>{
    const areaV = norm(selArea.value);
    const vpV   = norm(selVP.value);
    const base  = ALL_ITEMS.filter(x=>{
      const okA = !areaV || norm(x.area)   === areaV;
      const okV = !vpV   || norm(x.region) === vpV;
      return okA && okV;
    });
    const topics = uniqueSorted(base.map(x=>x.topic));
    fillSelect(selTopic, topics, '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
  };

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  refreshTopics();

  // Events
  selArea.onchange  = ()=>{ refreshTopics(); renderAreaContainers(); };
  selVP.onchange    = ()=>{ refreshTopics(); renderAreaContainers(); };
  selTopic.onchange = ()=>{ renderAreaContainers(); };
}
function filteredItems(ignoreResult=false){
  const areaSel  = norm(qs('f_area').value);
  const vpSel    = norm(qs('f_vp').value);     // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  const topicSel = norm(qs('f_topic').value);
  const result   = norm(qs('f_result').value);
  const storeQ   = norm(qs('f_store').value);

  return ALL_ITEMS.filter(it=>{
    const okA = !areaSel  || norm(it.area)    === areaSel;
    const okV = !vpSel    || norm(it.region)  === vpSel; // <-- ‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ region
    const okT = !topicSel || norm(it.topic)   === topicSel;
    const okS = !storeQ   || norm(it.storeCode).includes(storeQ) || norm(it.storeName).includes(storeQ);
    const okR = ignoreResult || !result || norm(it.answer).includes(result);
    return okA && okV && okT && okS && okR;
  });
}
/* ========= SMALL HELPERS ========= */
function pill(ans){
  const a = String(ans||'').toLowerCase();
  if(/green/.test(a)){
    return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-500 text-white" title="Green">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    </span>`;
  }
  if(/yellow/.test(a)){
    return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full" style="background:#FFFF00;color:#000" title="Yellow">Yellow</span>`;
  }
  if(/red/.test(a)){
    return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-rose-600 text-white" title="Red">Red</span>`;
  }
  return `<span class="text-slate-400">-</span>`;
}
function anyYellowRed(roundAns){
  const v = [roundAns[1], roundAns[2], roundAns[3]].map(x=>String(x||'').toLowerCase());
  if(v.some(a=>/red/.test(a))) return 'red';
  if(v.some(a=>/yellow/.test(a))) return 'yellow';
  return '';
}

/* ========= IMAGES ========= */
function normalizeImageUrl(u){
  if(!u) return '';
  try{
    const url = new URL(u);
    const host = url.hostname;
    if(host.includes('drive.google.com')){
      const m = u.match(/\/file\/d\/([^/]+)\//);
      const id = m?.[1] || url.searchParams.get('id');
      if(id) return `https://drive.google.com/uc?export=view&id=${id}`;
    }
    if(host.includes('dropbox.com')){
      url.searchParams.set('raw','1'); url.searchParams.delete('dl');
      return url.toString();
    }
    return u;
  }catch(_){ return u; }
}

/* ========= ROUNDS SCORE BOX ========= */
function fmtPct(v){
  if (v==null || v==='-' || v==='') return '-';
  const s = String(v).trim();
  if (s.endsWith('%')) return s;
  const n = Number(s);
  return Number.isFinite(n) ? n.toFixed(1)+'%' : s;
}

async function renderRoundScoresBox(){
  const host = qs('tileRoundWrap');
  host.innerHTML = '';
  const note = qs('roundScoreNote');

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á mapping storeCode -> storeName ‡∏à‡∏≤‡∏Å ALL_ITEMS
  const nameMap = new Map();
  ALL_ITEMS.forEach(x=>{
    const sc = String(x.storeCode||'').trim();
    const sn = String(x.storeName||'').trim();
    if(sc && sn && !nameMap.has(sc)) nameMap.set(sc, sn);
  });

  // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
  const stores = (SESSION?.scope?.stores?.length
    ? SESSION.scope.stores
    : Array.from(new Set(ALL_ITEMS.map(x=>x.storeCode).filter(Boolean)))
  ).sort((a,b)=> String(a).localeCompare(String(b),'th',{numeric:true}));

  note.textContent = `‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 3 ‡∏£‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π (${stores.length} ‡∏™‡∏≤‡∏Ç‡∏≤)`;

  // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤
  if(!stores.length){
    host.className = '';
    host.innerHTML = `
      <div class="rounded-xl border bg-white p-4 text-slate-600">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>
    `;
    return;
  }

  // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ö‡∏ö bulk: ‡πÑ‡∏î‡πâ { [storeCode]: { score:{1,2,3}, ... } }
  const rsp = await apiGet('round_scores_bulk', { codes: stores.join(',') }, { timeoutMs: 60000, retries: 1 });
  const map = (rsp.ok && rsp.data) ? rsp.data : {};

  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô container ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÅ‡∏ó‡∏ô grid ‡πÄ‡∏î‡∏¥‡∏°)
  host.className = '';
  host.innerHTML = `
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-slate-50 text-slate-700">
          <tr>
            <th class="px-3 py-2 text-left">Store Code</th>
            <th class="px-3 py-2 text-left">Store Name</th>
            <th class="px-3 py-2 text-center">Round 1</th>
            <th class="px-3 py-2 text-center">Round 2</th>
            <th class="px-3 py-2 text-center">Round 3</th>
          </tr>
        </thead>
        <tbody id="rsb_rows" class="[&>tr:nth-child(even)]:bg-slate-50/60"></tbody>
      </table>
    </div>
  `;

  const tbody = host.querySelector('#rsb_rows');
  const safe = (v)=> v==null ? '-' : v;
  stores.forEach(sc=>{
    const rec = map[sc] || { score:{1:'-',2:'-',3:'-'} };
    const sn  = nameMap.get(sc) || '';
    const r1  = fmtPct(rec.score?.[1]);
    const r2  = fmtPct(rec.score?.[2]);
    const r3  = fmtPct(rec.score?.[3]);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-3 py-2 font-semibold text-slate-900">${safe(sc)}</td>
      <td class="px-3 py-2 text-slate-700">${safe(sn)}</td>
      <td class="px-3 py-2 text-center">${safe(r1)}</td>
      <td class="px-3 py-2 text-center">${safe(r2)}</td>
      <td class="px-3 py-2 text-center">${safe(r3)}</td>
    `;
    tbody.appendChild(tr);
  });
}


function openSummaryModal(color){
  const modal = qs('summaryModal');
  const tbody = qs('sm_rows');
  const title = qs('sm_title');
  const count = qs('sm_count');

  const want = color.toLowerCase();
  const rows = ALL_ITEMS.filter(it=>{
    const ans = String(it.answer||'').toLowerCase();
    const st  = String(it.action?.status||'').toLowerCase();
    return ans.includes(want) && st !== 'done';
  });

  title.textContent = `‡∏™‡∏µ ${color} ‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà Action Status ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Done`;
  tbody.innerHTML = '';
  if (!rows.length){
    tbody.innerHTML = `<tr><td colspan="6" class="px-3 py-6 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á</td></tr>`;
  }else{
    rows.forEach(it=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-3 py-2">${it.storeCode||''}</td>
        <td class="px-3 py-2">${it.area||''}</td>
        <td class="px-3 py-2">${it.topic||''}</td>
        <td class="px-3 py-2">${it.question||''}</td>
        <td class="px-3 py-2 text-center">${it.answer||''}</td>
        <td class="px-3 py-2 text-center">${it.action?.status||''}</td>`;
      tbody.appendChild(tr);
    });
  }
  count.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  modal.classList.add('show'); modal.setAttribute('aria-hidden','false');

  const close = ()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); };
  qs('sm_close').onclick = close;
  qs('sm_ok').onclick = close;
  modal.querySelector('.backdrop').onclick = close;
  document.addEventListener('keydown', function esc(e){ if(e.key==='Escape'){ close(); document.removeEventListener('keydown', esc);} });
}

/* Carousel 3 ‡∏£‡∏π‡∏õ/‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß */
function buildRowAttach(host, images){
  if (!host) return;
  host.innerHTML = '';
  const wrap = document.createElement('div');
  wrap.className = 'row-att';

  const grid = document.createElement('div');
  grid.className = 'grid3';
  wrap.appendChild(grid);

  const nav = document.createElement('div');
  nav.className = 'nav';
  const btnPrev = document.createElement('button'); btnPrev.className='icon-btn';
  btnPrev.innerHTML = `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
  const pageLbl = document.createElement('span'); pageLbl.className='page';
  const btnNext = document.createElement('button'); btnNext.className='icon-btn';
  btnNext.innerHTML = `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
  nav.append(btnPrev,pageLbl,btnNext);

  let page=0, size=3;

  function render(){
    grid.innerHTML = '';
    const totalPages = Math.max(1, Math.ceil(images.length/size));
    const start = page*size;
    const slice = images.slice(start,start+size);

    if(slice.length===0){
      grid.innerHTML = `<div class="text-[10px] text-slate-400 col-span-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡∏ö</div>`;
      nav.style.display='none';
      return;
    }

    slice.forEach(src=>{
      const a = document.createElement('a'); a.href=src; a.target='_blank'; a.rel='noopener';
      const img = document.createElement('img'); img.alt='attach'; img.loading='lazy';
      img.src = src;
      img.addEventListener('error', ()=>{
        a.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå';
        a.className = 'text-[11px] underline text-slate-600 flex items-center justify-center h-16 border rounded';
      });
      a.appendChild(img);
      grid.appendChild(a);
    });

    pageLbl.textContent = `${Math.min(page+1,totalPages)}/${totalPages}`;
    btnPrev.disabled = page<=0;
    btnNext.disabled = page>=totalPages-1;
    nav.style.display = images.length>size ? 'flex' : 'none';
  }

  btnPrev.onclick = ()=>{ if(page>0){ page--; render(); } };
  btnNext.onclick = ()=>{ const totalPages = Math.ceil(images.length/size)||1; if(page<totalPages-1){ page++; render(); } };

  host.append(wrap,nav);
  render();
}

/* ========= PIVOT ========= */
function pivotByQuestionAcrossRounds(items){
  const map = new Map();
  for (const it of items){
    const area = it.area||''; const topic = it.topic||''; const question = it.question||'';
    const storeCode = it.storeCode||''; const storeName = it.storeName||'';
    const round = Number(it.round||0);
    const key = `${area}||${topic}||${question}||${storeCode}`;

    if(!map.has(key)){
      map.set(key, {
        key, area, topic, question, storeCode, storeName,
        roundAns:{1:null,2:null,3:null}, roundRaw:{1:null,2:null,3:null},
        action: it.action||null,
        actionId: getActionId(it),       // << ‡πÉ‡∏ä‡πâ helper
        refno: it.refno||'',
      });
    }
    const row = map.get(key);
    if (round===1||round===2||round===3){
      row.roundAns[round] = it.answer||null;
      row.roundRaw[round] = it;
    }
    // ‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (3 > 2 > 1)
    row.action   = (row.roundRaw[3]?.action || row.roundRaw[2]?.action || row.roundRaw[1]?.action || row.action || null);
    row.actionId = getActionId(row.roundRaw[3]) || getActionId(row.roundRaw[2]) || getActionId(row.roundRaw[1]) || row.actionId;
  }
  return Array.from(map.values());
}


function groupAreaTopicQuestion(rows){
  const g = new Map();
  for (const r of rows){
    if (!g.has(r.area)) g.set(r.area, new Map());
    const tmap = g.get(r.area);
    if (!tmap.has(r.topic)) tmap.set(r.topic, new Map());
    const qmap = tmap.get(r.topic);
    if (!qmap.has(r.question)) qmap.set(r.question, []);
    qmap.get(r.question).push(r);
  }
  return g;
}

/* ========= MODAL ========= */
function canEditAction(assignVal, statusVal){
  const a = String(assignVal||'').trim().toLowerCase();
  const s = String(statusVal||'').trim().toLowerCase();
  if (s === 'sent bu' || s === 'sent to bu' || s === 'sent') return false; // ‡∏™‡πà‡∏á BU ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡πá‡∏≠‡∏Å
  return a === 'operation'; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Assign = Operation
}

function applyActionEditability(){
  const actionEl = qs('am_action');
  if (!actionEl) return;
  const editable = canEditAction(qs('am_assign')?.value, qs('am_status')?.value);
  actionEl.readOnly = !editable;                          // ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
  actionEl.classList.toggle('bg-slate-100', !editable);   // ‡πÇ‡∏ó‡∏ô‡πÄ‡∏ó‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å
  actionEl.placeholder = editable
    ? '‡∏Å‡∏£‡∏≠‡∏Å Action ‡∏Ç‡∏≠‡∏á Operation...'
    : 'Action ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å (Assign ‚â† Operation ‡∏´‡∏£‡∏∑‡∏≠ Status = Sent BU)';
  actionEl.title = editable ? '' :
    'Action ‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Assign ‡πÄ‡∏õ‡πá‡∏ô Operation ‡πÅ‡∏•‡∏∞ Status ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Sent BU';
}

function validateActionInputs(){
  const reason = qs('am_reason')?.value?.trim();
  const assign = qs('am_assign')?.value?.trim();
  if (!reason){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Reason'); return false; }
  if (!assign){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Assign'); return false; }
  return true;
}

// ===== Modal =====

// ===== Helpers: ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ Action + Validate =====
function canEditAction(assignVal, statusVal){
  const a = String(assignVal||'').trim().toLowerCase();
  const s = String(statusVal||'').trim().toLowerCase();
  if (s === 'sent bu' || s === 'sent to bu' || s === 'sent') return false; // ‡∏™‡πà‡∏á BU ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡πá‡∏≠‡∏Å
  return a === 'operation'; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Assign = Operation
}

function applyActionEditability(){
  const actionEl = qs('am_action');
  if (!actionEl) return;
  const editable = canEditAction(qs('am_assign')?.value, qs('am_status')?.value);
  actionEl.readOnly = !editable;                          // ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
  actionEl.classList.toggle('bg-slate-100', !editable);   // ‡πÇ‡∏ó‡∏ô‡πÄ‡∏ó‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å
  actionEl.placeholder = editable
    ? '‡∏Å‡∏£‡∏≠‡∏Å Action ‡∏Ç‡∏≠‡∏á Operation...'
    : 'Action ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å (Assign ‚â† Operation ‡∏´‡∏£‡∏∑‡∏≠ Status = Sent BU)';
  actionEl.title = editable ? '' :
    'Action ‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Assign ‡πÄ‡∏õ‡πá‡∏ô Operation ‡πÅ‡∏•‡∏∞ Status ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Sent BU';
}

function validateActionInputs(){
  const reason = qs('am_reason')?.value?.trim();
  const assign = qs('am_assign')?.value?.trim();
  if (!reason){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Reason'); return false; }
  if (!assign){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Assign'); return false; }
  return true;
}

// ===== Modal =====
function openActionModal(ctx){
  AM_CTX = ctx;

  const setMeta = (id, val)=>{ const el = qs(id); el.textContent = val||'-'; el.title = val||'-'; };
  setMeta('am_meta_store', ctx.storeCode);
  setMeta('am_meta_topic', ctx.topic);
  setMeta('am_meta_question', ctx.question);

  qs('am_round').textContent = ctx.round;
  qs('am_comment_ro').textContent = ctx.currentComment || '‚Äî';

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Assign (‡∏Å‡∏±‡∏ô null element)
  const assignEl = qs('am_assign');
  if (assignEl) assignEl.innerHTML = buildBuOptions(ctx.currentAction?.bu || '');

  qs('am_reason').value = ctx.currentAction?.reason || '';
  qs('am_action').value = ctx.currentAction?.text || '';
  qs('am_status').value = ctx.currentAction?.status || 'Sent BU';
  qs('am_due').value    = (ctx.currentAction?.dueDate||'').slice(0,10);

  // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ Action ‡∏ï‡∏≤‡∏°‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÉ‡∏´‡∏°‡πà
  applyActionEditability();

  const m = qs('actionModal');
  m.classList.add('show'); m.setAttribute('aria-hidden','false');
}

function closeActionModal(){
  const m = qs('actionModal');
  m.classList.remove('show'); m.setAttribute('aria-hidden','true');
  AM_CTX=null;
}

// ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î/‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á/ESC
qs('am_close').onclick = closeActionModal;
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeActionModal(); });
qs('actionModal').querySelector('.backdrop').onclick = closeActionModal;

// ===== ‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ç‡πâ‡∏≤ queue (‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô Reason/Assign) =====
function queueActionChange(silent=true){
  if(!AM_CTX) return;

  const hasReason = !!qs('am_reason')?.value?.trim();
  const hasAssign = !!qs('am_assign')?.value?.trim();
  if(!hasReason || !hasAssign){
    if(!silent) alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Reason ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Assign ‡∏Å‡πà‡∏≠‡∏ô');
    return;
  }

  const actionFields = {
    reason: qs('am_reason').value,
    text:   qs('am_action').value,
    bu:     qs('am_assign').value,
    status: qs('am_status').value,
    dueDate:qs('am_due').value
  };
  const payload = { refno: AM_CTX.refno, action: actionFields };

  if (AM_CTX.key.startsWith('id:')){
    payload.actionid = AM_CTX.key.slice(3);
  } else {
    payload.context = {
      topic: AM_CTX.topic,
      question: AM_CTX.question,
      storeCode: AM_CTX.storeCode || '',
      round: AM_CTX.round || ''
    };
  }

  const changeKey = `${AM_CTX.key}|r${AM_CTX.round}|${AM_CTX.storeCode||''}`;
  CHANGES.set(changeKey, payload);
  refreshDirty();
}

// ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏Å‡∏•‡∏á: ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô validate ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
qs('am_ok').onclick = ()=>{
  if(!validateActionInputs()) return;
  queueActionChange(false); // ‡πÑ‡∏°‡πà silent -> ‡∏ñ‡πâ‡∏≤‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  closeActionModal();
};

// ===== Options Assign (‡∏Ñ‡∏á logic ‡πÄ‡∏î‡∏¥‡∏°) =====
function buildBuOptions(current){
  const pool = new Set(['Commercial','HR', 'Supply Chain', 'PPT-Maintenance', 'PPT-Town Center', 'Property', 'Wawee', 'Pure', 'Marketing']);
  ALL_ITEMS.forEach(it=>{ if(it.action?.bu) pool.add(it.action.bu); });
  return Array.from(pool).map(bu=>`<option ${bu===current?'selected':''}>${bu}</option>`).join('');
}

// ===== Listeners: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤ -> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß + ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ Action =====
['am_reason','am_action','am_assign','am_status','am_due'].forEach(id=>{
  const el = qs(id);
  if (el) el.addEventListener('change', ()=> queueActionChange(true));
});

// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Assign/Status ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ Action ‡∏î‡πâ‡∏ß‡∏¢
['am_assign','am_status'].forEach(id=>{
  const el = qs(id);
  if (el) el.addEventListener('change', applyActionEditability);
});


/* ========= RENDER ========= */
const cmpTH = (a, b) =>
  String(a ?? '').localeCompare(String(b ?? ''), 'th', { numeric: true, sensitivity: 'base' });

function renderAreaContainers(){
  const baseList   = filteredItems(true);
  let   pivotRows  = pivotByQuestionAcrossRounds(baseList);

  const resultSel = norm(qs('f_result').value);
  if (resultSel){
    pivotRows = pivotRows.filter(r =>
      [1,2,3].some(rd => norm(r.roundAns[rd]).includes(resultSel))
    );
  }

  const groups = groupAreaTopicQuestion(pivotRows);

  const host = qs('areaContainers');
  host.innerHTML = '';
  if(!pivotRows.length){
    host.innerHTML = `<div class="text-center text-slate-600 py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</div>`;
    return;
  }

  const areas = Array.from(groups.keys()).sort(cmpTH);
  for (const area of areas){
    const topicMap = groups.get(area);

    // ----- Area card -----
    const areaCard = document.createElement('div');
    areaCard.className = 'area-card';

    const theme = getAreaTheme(area);
    areaCard.style.borderColor = theme.bd;

    const head = document.createElement('div');
    head.className = 'area-head flex items-center justify-between';
    head.style.background = theme.bg;
    head.style.color = '#fff';
    head.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="area-chip">A</span>
        <div>
          <div class="font-semibold text-white">Area: ${area || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà)'}</div>
          <div class="text-xs text-white/80">Topic: ${topicMap.size}</div>
        </div>
      </div>`;
    areaCard.appendChild(head);

    const body = document.createElement('div');
    body.className = 'p-3 md:p-4 space-y-4';

    const topics = Array.from(topicMap.keys()).sort(cmpTH);
    for (const topic of topics){
      const qmap = topicMap.get(topic);

      const topicBox  = document.createElement('div');
      topicBox.className  = 'rounded-xl border border-slate-200 bg-white/70';

      const topicHead = document.createElement('div');
      topicHead.className = 'px-3 py-2 border-b bg-slate-50/70 rounded-t-xl';
      topicHead.innerHTML = `<div class="font-medium text-slate-800">Topic: ${topic || '-'}</div>`;
      topicBox.appendChild(topicHead);

      const topicBody = document.createElement('div');
      topicBody.className = 'p-2 space-y-4';

      const questions = Array.from(qmap.keys()).sort(cmpTH);
      for (const question of questions){
        const rows = qmap.get(question).slice().sort((a,b)=>cmpTH(a.storeCode, b.storeCode));

        const qBox = document.createElement('div');
        qBox.className = 'rounded-lg border border-slate-200 bg-white';
        qBox.innerHTML = `
          <div class="px-3 py-2 border-b bg-white rounded-t-lg">
            <div class="text-[13px] text-slate-700">
              <span class="font-semibold">Question:</span> ${question || '-'}
            </div>
          </div>
          <div class="p-2">
            <table class="text-sm">
              <thead class="bg-slate-50 text-slate-700">
                <tr>
                  <th class="px-2 py-2 text-left  w-[220px]">Store</th>
                  <th class="px-2 py-2 text-center w-[110px]">Round1</th>
                  <th class="px-2 py-2 text-center w-[110px]">Round2</th>
                  <th class="px-2 py-2 text-center w-[110px]">Round3</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>`;
        const tbody = qBox.querySelector('tbody');

        rows.forEach(row=>{
          const tr = document.createElement('tr');
          const tone = anyYellowRed(row.roundAns);
          if(tone==='red') tr.classList.add('row-red');
          else if(tone==='yellow') tr.classList.add('row-yellow');

          const key = getActionId(row) ? `id:${getActionId(row)}` : `ctx:${row.topic}|${row.question}`;

          tr.innerHTML = `
            <td class="px-2 py-2 align-top">
              <div class="font-semibold">${row.storeCode || ''}</div>
              <div class="text-[11px] text-slate-500">${row.storeName || ''}</div>
              <div class="row-att mt-1" data-att></div>
            </td>
            ${[1,2,3].map(rn=>{
              const ans = row.roundAns[rn];
              const isYR = /yellow|red/i.test(String(ans||''));

              // ‚úÖ ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á "‡∏£‡∏≠‡∏ö‡∏ô‡∏±‡πâ‡∏ô" ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢‡∏ñ‡∏≠‡∏¢‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
              const perRoundAct   = row.roundRaw?.[rn]?.action || null;
              const perRoundId    = getActionId(row.roundRaw?.[rn]) || '';
              const latestAct     = row.action || null;
              const actStatus     = perRoundAct?.status ?? latestAct?.status ?? '';
              const isDoneThisRnd = normalizeStatus(actStatus) === 'done';

              const btnHtml = isYR ? `
                <button class="icon-btn" title="${isDoneThisRnd ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (Done)' : '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≠‡∏ö '+rn}" data-plus
                  data-key="${key}"
                  data-refno="${row.roundRaw?.[rn]?.refno||''}"
                  data-topic="${row.topic}" data-question="${row.question}"
                  data-round="${rn}" data-store="${row.storeCode || ''}">
                  ${
                    isDoneThisRnd
                    ? `<svg class="w-4 h-4 text-emerald-600" viewBox="0 0 24 24" fill="none">
                         <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                       </svg>`
                    : `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                         <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                       </svg>`
                  }
                </button>` : ``;

              return `
                <td class="px-2 py-2 align-top text-center">
                  <div class="flex items-center justify-center gap-2">
                    ${pill(ans)}
                    ${btnHtml}
                  </div>
                </td>`;
            }).join('')}
          `;

          // ‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡∏ö
          const attHost = tr.querySelector('[data-att]');
          const imgs = [1,2,3]
            .flatMap(rn => (row.roundRaw?.[rn]?.attachments || []).map(a => a.url))
            .filter(Boolean);
          if (attHost) buildRowAttach(attHost, imgs);

          // ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏•: ‡∏™‡πà‡∏á action/id ‡∏Ç‡∏≠‡∏á "‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å" ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
          tr.querySelectorAll('[data-plus]').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              const rn = Number(btn.getAttribute('data-round'));
              const perRoundRaw  = row.roundRaw?.[rn] || {};
              const ctx = {
                refno: perRoundRaw.refno || '',
                key:   btn.getAttribute('data-key'),
                topic: btn.getAttribute('data-topic'),
                question: btn.getAttribute('data-question'),
                storeCode: btn.getAttribute('data-store'),

                // ‚úÖ ‡πÉ‡∏ä‡πâ actionid ‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
                actionid: getActionId(perRoundRaw) || getActionId(row) || null,

                round: rn,

                // ‚úÖ ‡∏™‡πà‡∏á currentAction ‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤ reset
                currentAction: perRoundRaw.action || row.action || {},

                currentComment: perRoundRaw.comment || ''
              };
              openActionModal(ctx);
            });
          });

          tbody.appendChild(tr);
        });

        topicBody.appendChild(qBox);
      }

      topicBox.appendChild(topicBody);
      body.appendChild(topicBox);
    }

    areaCard.appendChild(body);
    host.appendChild(areaCard);
  }
}

/* ========= NAV & SIDEBAR ========= */
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.onclick = ()=> setActiveTab(btn.dataset.tab);
});
const sidebar = qs('sidebar');
const overlay = qs('sbOverlay');
function closeAllOverlaysBeforeSidebarToggle(){ closeActionModal(); overlay.classList.remove('show'); }
qs('btnHamburger').onclick = ()=>{
  closeAllOverlaysBeforeSidebarToggle();
  const isMobile = window.innerWidth <= 1024;
  if (isMobile){
    sidebar.classList.toggle('open');
    overlay.classList.toggle('show');
    document.body.classList.toggle('overflow-hidden', sidebar.classList.contains('open'));
  }else{
    sidebar.classList.toggle('closed');
  }
};
overlay.onclick = ()=>{
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
  document.body.classList.remove('overflow-hidden');
};

/* ========= SAVE BAR (optional batch) ========= */
function refreshDirty(){
  const n = CHANGES.size;
  qs('dirtyCount').textContent = n;
  show(qs('saveBar'), n>0);
  const topBtn = qs('btnSaveAllTop'); topBtn.disabled = n===0; topBtn.classList.toggle('opacity-40', n===0);
}
qs('btnSaveAllTop').onclick = ()=> qs('btnSaveAll').click();
qs('btnSaveAll').onclick = async ()=>{
  if(!CHANGES.size) return;
  loading(true);
  const nBefore = CHANGES.size;
  try{
    for(const [_, payload] of CHANGES){
      const rsp = await apiPost('action_update', payload);
      if(!rsp.ok) throw new Error(rsp.error||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
    CHANGES.clear(); refreshDirty();
    await loadEvaluations();
    qs('lastSaved').textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${new Date().toLocaleString('th-TH')}`;
    showSuccess(nBefore);
  }catch(ex){ alert(ex.message); }
  finally{ loading(false); }
};

function showSuccess(n){
  qs('succ_count').textContent = n;
  qs('saveSuccess').classList.remove('hidden');
}
qs('succ_close')?.addEventListener('click', ()=> qs('saveSuccess').classList.add('hidden'));


/* ========= EXPORT ========= */
(() => {
  const btn = qs('btnExport');
  const menu = qs('exportMenu');
  if (!btn || !menu) return; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°/‡πÄ‡∏°‡∏ô‡∏π ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á bind ‡∏≠‡∏∞‡πÑ‡∏£

  btn.addEventListener('click', () => {
    menu.classList.toggle('hidden');
  });

  document.addEventListener('click', (e) => {
    const t = e.target;
    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏õ‡∏∏‡πà‡∏° -> ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π
    if (!t.closest('#exportMenu') && !t.closest('#btnExport')) {
      menu.classList.add('hidden');
    }
  });

  menu.addEventListener('click', (e) => {
    const t = e.target.closest('button[data-export]');
    if (!t) return;
    const act = t.dataset.export;
    menu.classList.add('hidden');

    if (act === 'print') {
      window.print();
    } else if (act === 'csv') {
      exportCSVCurrent();
    } else if (act === 'excel') {
      exportExcelPretty();
     } else if (act === 'import') {
    const input = document.getElementById('excelInput');
    if (!input) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö #excelInput'); return; }
    input.click(); // ‡πÄ‡∏õ‡∏¥‡∏î file picker
  }
 });
})();

// ================== CSV ==================

function toCSVWithHeaders(headers, rows){
  // headers: [{ header:'Action ID', key:'actionid' }, ...]
  const esc = s => `"${String(s ?? '').replace(/"/g,'""')}"`;
  const headLine = headers.map(h => esc(h.header)).join(',');
  const body = rows.map(r => headers.map(h => esc(r[h.key])).join(',')).join('\n');
  return headLine + '\n' + body;
}

// ===== 2) Export CSV (‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö/‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà) =====
const EXPORT_HEADERS = [
  'refno','round','storeCode','storeName','area','topic','question','answer',
  'actionid','assign','action','reason','status','dueDate'
];

// build rows for export (mode kept for compatibility)
function buildExportRows(mode='per-round'){
  const rows = [];

  // safe date formatter: prefer global toISODate if present, otherwise minimal fallback
  const fmt = (v) => {
    if (typeof toISODate === 'function') return toISODate(v);
    if (v === null || v === undefined || v === '') return '';
    if (v instanceof Date && !isNaN(v)) return v.toISOString().slice(0,10);
    const s = String(v).trim();
    if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
    if (/^\d{2}\/\d{2}\/\d{4}/.test(s)) {
      // dd/mm/yyyy -> yyyy-mm-dd (basic)
      const [d,m,y] = s.split('/');
      return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    }
    const d2 = new Date(s);
    return isNaN(d2) ? '' : d2.toISOString().slice(0,10);
  };

  for (const it of ALL_ITEMS || []) {
    const action = it.action || {};
    const aid = getActionId(it);
    rows.push({
      refno: it.refno ?? it.ref_no ?? '',
      round: it.round ?? '',
      storeCode: it.storeCode ?? it.store_code ?? it.store ?? '',
      storeName: it.storeName ?? it.store_name ?? it.storeNameThai ?? '',
      area: it.area ?? '',
      topic: it.topic ?? it.topic_name ?? '',
      question: it.question ?? it.question_text ?? it.q ?? '',
      answer: it.answer ?? it.result ?? '',
      actionid: aid,
      assign: action.assign ?? action.assignee ?? action.bu ?? it.assign ?? '',
      action: action.text ?? action.action ?? it.actionText ?? '',
      reason: action.reason ?? it.reason ?? '',
      status: action.status ?? it.status ?? '',
      dueDate: fmt(action.dueDate ?? action.due_date ?? action.due ?? it.dueDate ?? it.action_due_date ?? '')
    });
  }
  return rows;
}

function escapeCsvCell(v){
  if (v == null) return '';
  const s = String(v);
  if (/[",\r\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

function toCSVOrdered(rows, headers=EXPORT_HEADERS){
  const lines = [];
  lines.push(headers.join(','));
  for (const r of rows){
    const cols = headers.map(h => escapeCsvCell(r[h] ?? ''));
    lines.push(cols.join(','));
  }
  return lines.join('\r\n');
}

// ====== Export CSV ======
function exportCSVCurrent({ mode='per-round' } = {}){
  const rows = buildExportRows(mode);
  const csv  = '\ufeff' + toCSVOrdered(rows); // BOM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Excel/Windows
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = `site-store-${mode}-${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ====== Export Excel (‡∏™‡∏ß‡∏¢ + ‡∏™‡∏µ + Freeze header) ======
async function exportExcelPretty({ mode='per-round' } = {}) {
  if (typeof ExcelJS === 'undefined') throw new Error('ExcelJS ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î');
  const rows = buildExportRows(mode);
  if (!Array.isArray(rows) || rows.length === 0) throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');

  const headers = Array.isArray(EXPORT_HEADERS) && EXPORT_HEADERS.length ? EXPORT_HEADERS.slice() : Object.keys(rows[0]);

  const wb = new ExcelJS.Workbook();
  const ws = wb.addWorksheet('Sheet1');

  // define columns so ExcelJS maps object keys to cells
  ws.columns = headers.map(h => ({ header: h, key: h, width: Math.max(12, Math.min(40, String(h).length + 8)) }));

  // ensure every row has all header keys (no undefined)
  ws.addRows(rows.map(r => {
    const obj = {};
    for (const h of headers) obj[h] = (r[h] != null) ? r[h] : '';
    return obj;
  }));

  // header style + freeze
  const headerRow = ws.getRow(1);
  headerRow.font = { bold:true };
  headerRow.alignment = { vertical:'middle', horizontal:'center' };
  ws.views = [{ state:'frozen', ySplit:1 }];

  // auto-filter safe (uses defined columns)
  ws.autoFilter = { from: 'A1', to: ws.getCell(1, ws.columnCount).address };

  const buf = await wb.xlsx.writeBuffer();
  const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  saveAs(blob, `site-store-${mode}-${Date.now()}.xlsx`);
}

// ================== IMPORT (Excel ‚Üí Supabase) ==================
async function importActionsXlsxToSupabase(
  fileOrBlob,
  { supabaseUrl, supabaseKey, tableName='SITESTORE', chunkSize=40, dryRun=false } = {}
){
  if (typeof ExcelJS === 'undefined') {
    throw new Error('ExcelJS ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î');
  }
  if (typeof window !== 'undefined' && typeof window.supabase === 'undefined') {
    throw new Error('supabase-js ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î');
  }
  if (!supabaseUrl || !supabaseKey) {
    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ supabaseUrl ‡πÅ‡∏•‡∏∞ supabaseKey');
  }

  const sb = window.supabase.createClient(supabaseUrl, supabaseKey, {
    auth: { persistSession: false }
  });

  const lc = s => String(s ?? '').trim().toLowerCase();
  const normBU = (s) => {
    const v = lc(s);
    if (!v) return '';
    if (v === 'opr' || v === 'operation' || v === 'operations') return 'Operation';
    if (v === 'hr') return 'HR';
    if (v === 'it') return 'IT';
    if (v === 'qa' || v === 'quality') return 'QA';
    if (v === 'finance' || v === 'fin') return 'Finance';
    if (v === 'safety' || v === 'ohs') return 'Safety';
    return s.charAt(0).toUpperCase() + s.slice(1);
  };
  const normStatus = (s) => {
    const v = lc(s);
    if (!v) return '';
    if (v === 'done') return 'Done';
    if (v === 'in progress' || v === 'inprogress' || v === 'progress') return 'In progress';
    if (v === 'sent' || v === 'sent bu' || v === 'sent to bu') return 'Sent BU';
    return s.trim();
  };
  const toISODate = (x) => {
    if (!x && x !== 0) return '';
    if (x instanceof Date && !isNaN(x)) {
      const y = x.getFullYear();
      const m = String(x.getMonth()+1).padStart(2,'0');
      const d = String(x.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    if (typeof x === 'number' && isFinite(x)) {
      const excelEpoch = new Date(1899, 11, 30);
      const ms = x * 86400000;
      const dt = new Date(excelEpoch.getTime() + ms);
      return isNaN(dt) ? '' : toISODate(dt);
    }
    const s = String(x).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    if (/^\d{4}\/\d{2}\/\d{2}$/.test(s)) return s.replace(/\//g,'-');
    const d2 = new Date(s);
    return isNaN(d2) ? '' : toISODate(d2);
  };
  const same = (a,b) => (a ?? null) === (b ?? null);
  const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

  const wb = new ExcelJS.Workbook();
  const buffer = fileOrBlob instanceof ArrayBuffer
    ? fileOrBlob
    : (fileOrBlob.arrayBuffer ? await fileOrBlob.arrayBuffer() : await fileOrBlob.blob().arrayBuffer());
  await wb.xlsx.load(buffer);
  const ws = wb.worksheets[0];
  if (!ws) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö worksheet ‡πÅ‡∏£‡∏Å‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');

  const headerIndex = (row) => {
    const map = {};
    row.eachCell((cell, col) => {
      const name = lc(String(cell.value||'').replace(/\s+/g,'').replace(/_/g,'')); 
      if (name) map[name] = col;
    });
    if (!map.actionid) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "actionid" ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel');
    const req = ['reason','action','bu','duedate','actionstatus'];
    const miss = req.filter(k => !(k in map));
    if (miss.length) throw new Error('‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏≤‡∏¢‡πÑ‡∏õ: ' + miss.join(', '));
    return map;
  };

  const H = headerIndex(ws.getRow(1));

  const rawRows = [];
  for (let r=2; r<=ws.rowCount; r++){
    const row = ws.getRow(r);
    const get = (key) => {
      const col = H[key]; if (!col) return '';
      const v = row.getCell(col)?.value;
      return (v && typeof v === 'object' && 'text' in v) ? String(v.text) : v;
    };
    const actionid  = String(get('actionid') ?? '').trim();
    const reason    = String(get('reason') ?? '').trim();
    const actionTxt = String(get('action') ?? '').trim();
    const bu        = normBU(get('bu'));
    const status    = normStatus(get('actionstatus'));
    const due       = toISODate(get('duedate'));

    if (!actionid) continue; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏µ‡∏¢‡πå -> ‡∏Ç‡πâ‡∏≤‡∏°
    rawRows.push({ _excelRow:r, actionid, reason, actionTxt, bu, status, due });
  }
  if (!rawRows.length) {
    return { ok:false, summary:{ total:0 }, detail:[], message:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå' };
  }

  // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ã‡πâ‡∏≥)
  const uniqIds = Array.from(new Set(rawRows.map(x=>x.actionid)));
  const existingMap = new Map();
  for (let i=0;i<uniqIds.length;i+=1000) {
    const part = uniqIds.slice(i,i+1000);
    const { data, error } = await sb
      .from(tableName)
      .select('actionid, action_reason, action_text, action_bu, action_due_date, action_status')
      .in('actionid', part);
    if (error) throw new Error('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (error.message||error));
    (data||[]).forEach(r => existingMap.set(String(r.actionid), r));
  }

  const plan = [], skipped = [], errors = [];
  for (const rr of rawRows) {
    const cur = existingMap.get(rr.aactionid);
    if (!cur) { skipped.push({ row: rr._excelRow, actionid: rr.actionid, reason:'‡πÑ‡∏°‡πà‡∏û‡∏ö actionid ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' }); continue; }
    if (!rr.reason) { errors.push({ row: rr._excelRow, actionid: rr.actionid, error:'reason ‡∏ß‡πà‡∏≤‡∏á' }); continue; }
    if (!rr.bu)     { errors.push({ row: rr._excelRow, actionid: rr.actionid, error:'bu ‡∏ß‡πà‡∏≤‡∏á' }); continue; }
    const allowActionText = (rr.bu === 'Operation' && rr.status !== 'Sent BU');
    const nextActionText  = allowActionText ? (rr.actionTxt || null) : null;
    const nextDue = rr.due ? rr.due : null;
    if (rr.due && !/^\d{4}-\d{2}-\d{2}$/.test(rr.due)) {
      errors.push({ row: rr._excelRow, actionid: rr.actionid, error:'duedate ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD' }); continue;
    }

    const will = {
      actionid       : rr.actionid,
      action_reason   : rr.reason,
      action_text     : nextActionText,
      action_bu       : rr.bu,
      action_status   : rr.status,
      action_due_date : nextDue
    };
    const old = {
      action_reason   : cur.action_reason ?? null,
      action_text     : cur.action_text ?? null,
      action_bu       : cur.action_bu ?? null,
      action_status   : cur.action_status ?? null,
      action_due_date : cur.action_due_date ?? null
    };

    const eq =
      same(will.action_reason, old.action_reason) &&
      same(will.action_text,   old.action_text)   &&
      same(will.action_bu,     old.action_bu)     &&
      same(will.action_status, old.action_status) &&
      same(will.action_due_date, old.action_due_date);

    if (eq) { skipped.push({ row: rr._excelRow, actionid: rr.actionid, reason:'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á' }); continue; }
    plan.push({ row: rr._excelRow, update: will });
  }

  if (!plan.length && !errors.length) {
    return { ok:true, summary:{ total: rawRows.length, planned:0, updated:0, skipped: skipped.length, errors:0 }, detail: skipped };
  }

  const updateOne = async (obj) => {
    if (dryRun) return { ok:true, updated:0, dryRun:true };
    const { data, error } = await sb
      .from(tableName)
      .update({
        action_reason    : obj.action_reason,
        action_text      : obj.action_text,
        action_bu        : obj.action_bu,
        action_status    : obj.action_status,
        action_due_date  : obj.action_due_date
      })
      .eq('actionid', obj.actionid)
      .select('actionid');
    if (error) return { ok:false, error };
    return { ok:true, updated:(data?.length||0) };
  };

  let updated = 0; const failures = [];
  for (let i=0;i<plan.length;i+=chunkSize){
    const bucket = plan.slice(i,i+chunkSize);
    for (const job of bucket) {
      const res = await updateOne(job.update);
      if (res.ok && res.updated > 0) updated += res.updated;
      else if (res.ok && res.updated === 0) failures.push({ row: job.row, actionid: job.update.actionid, error:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡πâ update' });
      else failures.push({ row: job.row, actionid: job.update.actionid, error: res.error?.message || String(res.error) });
      await sleep(10);
    }
    await sleep(60);
  }

  return {
    ok: failures.length === 0 && errors.length === 0,
    summary: { total: rawRows.length, planned: plan.length, updated, skipped: skipped.length, errors: errors.length + failures.length },
    detail:  [
      ...skipped.map(x => ({ type:'skipped', ...x })),
      ...errors.map(x => ({ type:'invalid', ...x })),
      ...failures.map(x => ({ type:'failed',  ...x }))
    ]
  };
}

// ======= Hook input file ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ =======
(() => {
  const input = document.getElementById('excelInput');
  if (!input) return; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
  input.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try{
      const result = await importActionsXlsxToSupabase(file, {
        supabaseUrl: 'https://iodmkpvgrvlpiydurimv.supabase.co',
        supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZG1rcHZncnZscGl5ZHVyaW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MTE5MDksImV4cCI6MjA3MzQ4NzkwOX0.8lGDPEnViaLBY0mDf2IfsfwGI8qBFO7G01tC_BnR3cs',
        tableName: 'SITESTORE',
        chunkSize: 40,
        dryRun: false
      });
      console.log(result.summary, result.detail);
      alert(
        `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.summary.updated} / ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô: ${result.summary.planned}\n` +
        `‡∏Ç‡πâ‡∏≤‡∏°: ${result.summary.skipped} ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.summary.errors}`
      );
    }catch(ex){
      alert(ex.message || String(ex));
    }finally{
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      e.target.value = '';
    }
  });
})();
</script>
</body>
</html>
