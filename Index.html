<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Site-Store | ผลประเมินสาขา</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap');
:root{
  --radius: 14px;
  --ring: rgba(255,255,255,.38);
  --glass: rgba(255,255,255,.55);
}
html,body{
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
body{
  /* สแต็กฟอนต์แบบ iOS + สำรองเป็น Sarabun สำหรับภาษาไทย */
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue",
               "Segoe UI", "Sarabun", system-ui, sans-serif;
  letter-spacing: .1px;
}

/* ===== Liquid Glass card ===== */
.liquid{
  background: linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.35));
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border: 1px solid var(--ring);
  border-radius: var(--radius);
  box-shadow:
    0 8px 24px rgba(2,6,23,.10),
    inset 0 1px 0 rgba(255,255,255,.45);
}

/* เน้นอินพุตแบบ iOS */
.ios-input{
  height: 40px;
  border-radius: 12px;
  padding: 0 .625rem;
  border: 1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.8);
  transition: box-shadow .2s ease, border-color .2s ease;
}
.ios-input:focus{
  outline: none;
  border-color: rgba(59,130,246,.45);
  box-shadow: 0 0 0 4px rgba(59,130,246,.12);
}

/* ปุ่มแนว iOS */
.ios-btn{
  height: 40px;
  border-radius: 12px;
  font-weight: 600;
}
/* ===== Area card: คอนทราสต์ชัดขึ้น + หัวสีเข้ม ===== */
.area-card{
  border: 2px solid rgba(2,6,23,.15);
  border-radius: 18px;
  background: #fff;
  box-shadow: 0 10px 24px rgba(2,6,23,.08);
}
.area-head{
  padding:.75rem 1rem;
  border-bottom: 1px solid rgba(255,255,255,.35);
  color:#fff;
  border-top-left-radius:18px;
  border-top-right-radius:18px;
}
.area-chip{
  display:inline-flex; align-items:center; justify-content:center;
  width:28px; height:28px; border-radius:.75rem;
  background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.35);
  color:#fff; font-weight:700;
}
.glass{ background:rgba(255,255,255,.8); backdrop-filter: blur(10px); }
.shimmer{ position:relative; overflow:hidden; background:#f3f4f6; }
.shimmer::after{ content:""; position:absolute; inset:0; transform:translateX(-100%);
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.55),transparent);
  animation:sh 1.1s infinite;
}
@keyframes sh{ 100%{ transform:translateX(100%);} }

    @media (max-width: 768px){
  .filters-row{
    overflow-x: visible;
  }
  .filters-row > label{
    min-width: 100%;
  }
  .filters-row > .flex{
    width: 100%;
    justify-content: flex-start;
  }
}
/* ===== SIDEBAR: desktop = sticky / mobile = overlay ===== */

/* พื้นฐานร่วมกันทุกขนาดจอ */
.sidebar{
  width: 280px;
  border-right: 1px solid #e2e8f0;
  background: #fff;
}

/* --- Desktop (>=1025px): ติดขอบซ้าย ไม่ทับเนื้อหา --- */
@media (min-width: 1025px){
  .sidebar{
    position: sticky;
    top: 56px;                         /* อยู่ใต้ topbar */
    height: calc(100vh - 56px);
    overflow-y: auto;
    align-self: flex-start;
    z-index: 10;
  }
  .sidebar.closed{
    width: 0 !important;
    border-right: 0 !important;
    overflow: hidden;
  }
}

/* --- Mobile / Tablet (<=1024px): ให้เป็น overlay เลื่อนเข้าจอ --- */
@media (max-width: 1024px){
  .sidebar{
    position: fixed;
    left: 0;
    top: 56px;                          /* อยู่ใต้ topbar */
    height: calc(100vh - 56px);
    transform: translateX(-100%);
    transition: transform .25s ease;
    z-index: 40;
  }
  .sidebar.open{
    transform: translateX(0);
  }

  .overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.45);
    backdrop-filter: blur(2px);
    z-index: 30;
    display: none;
  }
  .overlay.show{
    display: block;
  }
}

/* ========== FILTER BAR (Sticky ใต้ Topbar) ========== */
.filters-bar{
  position: sticky;
  top: 56px;                /* ให้อยู่ใต้ topbar */
  z-index: 25;              /* สูงกว่า content แต่ต่ำกว่า modal */
  background:#fff;          /* พื้นหลังทึบเพื่อไม่ให้เห็นเนื้อหาซ้อน */
  border-bottom:1px solid #e2e8f0;
  box-shadow: 0 1px 0 rgba(0,0,0,.02);
}

/* กันเวลามี anchor/scrollTo แล้วหัวข้อถูกบังด้วยแถบ filters */
.anchor-target{ scroll-margin-top: 120px; } /* 56 (topbar) + ~64 (filters) ตีเผื่อ */

/* ===== Green Modern Login ===== */
.login-wrap{
  min-height: 100dvh;
  background: #f3f7f5;                 /* พื้นหลังเขียวอ่อนสะอาด */
  display:flex; align-items:center; justify-content:center; padding: 20px;
}
.login-card{
  width: 100%; max-width: 520px;
  background:#ffffff; border:1px solid #e8f1ea;
  border-radius: 22px;
  box-shadow: 0 14px 36px rgba(16,185,129,.12);
  padding: 28px;
}

/* โลโก้: ไม่มีกรอบ/เงา และขยายให้ใหญ่ขึ้น */
.login-hero{
  display:flex; align-items:center; justify-content:center;
  margin-top: -30px;            /* ยกโลโก้ขึ้นเล็กน้อย */
  margin-bottom: 10px;
}

.login-logo{
  /* ยกเลิกกรอบ กล่องพื้นหลัง เงา ทุกอย่าง */
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;

  /* ให้ container นี้ไม่บังคับสัดส่วน/ขนาด */
  width: auto; height: auto; padding: 0;
}

.login-logo img{
  /* ขยายรูป — เลือกขนาดใหญ่สุด แต่ยัง responsive */
  width: min(260px, 70vw);
  height: auto;

  /* ไม่มีกล่อง/กรอบ/เงา/ขอบขาว */
  border: none !important;
  border-radius: 0 !important;   /* ถ้าอยากมน ให้เปลี่ยนเป็น 16px */
  box-shadow: none !important;

  object-fit: contain;           /* แสดงเต็มรูป ไม่บิด */
  display: block;
}


.login-title{
  text-align:center; font-weight:900; color:#064e3b; font-size: 24px; line-height:1.2;
}
.login-sub{
  text-align:center; color:#0f766e; font-size: 13px; margin-top: 4px;
}

.login-field{ margin-top:16px; }
.ios-input--lg{ height: 46px; border-radius: 14px; padding: 0 12px; }
.ios-input--lg:focus{ outline:none; box-shadow:0 0 0 4px rgba(16,185,129,.15); border-color:#10b981; }

/* segmented radio: โทนเขียว */
.role-seg{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:10px; }
.role-btn{
  display:flex; align-items:center; justify-content:center; gap:8px;
  border:1px solid #e5efe8; border-radius:12px; padding:10px 12px;
  background:#fff; color:#064e3b; font-weight:700; font-size:13px;
  transition: all .16s ease;
}
.role-btn:hover{ background:#f0fdf4; }
input[name="role"]{ display:none; }
input[name="role"]:checked + label{
  border-color:#10b981; background:#ecfdf5; box-shadow:0 0 0 3px rgba(16,185,129,.18) inset;
}

/* ปุ่ม Login โทนเขียว */
.btn-login{
  height: 46px; border-radius: 14px; width:100%;
  background:#10b981; color:#ffffff; font-weight:800;
  box-shadow: 0 14px 28px rgba(16,185,129,.28);
  transition: transform .06s ease, background .15s ease;
}
.btn-login:hover{ background:#059669; }
.btn-login:active{ transform: translateY(1px); }

.login-foot{ margin-top:10px; color:#0f766e; font-size:12px; text-align:center; }

/* ยกเลิกพื้นหลัง gradient เดิมของ body ถ้ามี */
body{ background:#f3f7f5 !important; }


/* ตารางเต็มจอ ไม่เลื่อนซ้ายขวา */
table{ table-layout: fixed; width:100%; }
th,td{ word-break:break-word; }

.icon-btn{ display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:.5rem; border:1px solid rgba(15,23,42,.12); background:#fff; }
.icon-btn:hover{ background:#f8fafc; }

/* Modal (scrollable, tidy layout) */
.modal{ position:fixed; inset:0; z-index:50; display:none; pointer-events:none; }
.modal.show{ display:block; pointer-events:auto; }
.modal .backdrop{ position:absolute; inset:0; background:rgba(2,6,23,.45); backdrop-filter:blur(2px); }
.modal .panel{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:16px; }
.modal .card{
  width:100%; max-width:1040px; background:#fff; border-radius:1rem;
  box-shadow:0 20px 48px rgba(2,6,23,.25);
  display:flex; flex-direction:column;
  max-height:90vh; overflow:hidden;
}
.modal .head{
  padding:.875rem 1rem; border-bottom:1px solid #e2e8f0;
  display:flex; align-items:start; justify-content:space-between; gap:1rem;
  position:sticky; top:0; background:#fff; z-index:1;
}
.modal .body{ padding:1rem; overflow-y:auto; }
.modal .foot{ padding:1rem; border-top:1px solid #e2e8f0; position:sticky; bottom:0; background:#fff; z-index:1; }

.meta-row{ display:grid; grid-template-columns:1fr; gap:.25rem; }
@media (min-width: 768px){
  .meta-row{ grid-template-columns: repeat(3, 1fr); }
}
.meta-item{ font-size:13px; color:#334155; }
.meta-item .label{ color:#64748b; margin-right:.25rem; }
.meta-item .text{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

/* Row highlight */
.row-yellow{ background:#FFFBD1; }  /* เหลืองอ่อน อ่านง่าย */
.row-red{ background:#FFE5E9; }

/* Row attachments (3-up) */
.row-att{ margin-top:.25rem; }
.row-att .grid3{ display:grid; grid-template-columns:repeat(3,1fr); gap:.25rem; }
.row-att img{ width:100%; height:56px; object-fit:cover; border-radius:.375rem; border:1px solid rgba(15,23,42,.1); }

.row-att .nav{ display:flex; align-items:center; gap:.25rem; margin-top:.25rem; }
.row-att .page{ font-size:11px; color:#475569; }

/* ซ่อนสกรอลบาร์แนวนอนให้เนียน */
.no-scrollbar::-webkit-scrollbar{ display:none; }
.no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

/* ขนาดเล็กลง */
.ios-input--sm{ height:36px; padding:0 .5rem; font-size:13px; border-radius:10px; }
.ios-btn--sm{ height:36px; padding:0 .75rem; border-radius:10px; font-weight:600; font-size:14px; }

.logo-wide {
  aspect-ratio: 1355 / 392;
  height: 40px;
  width: auto;
  object-fit: contain;
}

/* ===== Spinner Loader ===== */
#loader{
  position: fixed; inset: 0;
  display: none; /* โชว์เมื่อมีคลาส .show */
  align-items: center; justify-content: center;
  background: rgba(255,255,255,.55);
  backdrop-filter: blur(3px);
  z-index: 50;
}
#loader.show{ display:flex; }
.loader-box{
  background: rgba(255,255,255,.9);
  border-radius: 16px;
  border: 1px solid var(--ring);
  box-shadow: 0 8px 24px rgba(2,6,23,.12);
  padding: 10px 14px;
  display: inline-flex; align-items: center; gap: 10px;
}
.spinner{
  width: 26px; height: 26px; border-radius: 9999px;
  border: 3px solid rgba(2,6,23,.2);
  border-top-color: #0ea5e9;
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg);} }


html, body { max-width: 100%; overflow-x: hidden; }

@media (max-width: 640px){
  .h-tight { letter-spacing: .1px; }
  .text-hero { font-size: 18px; line-height: 1.25; }
  .text-sub  { font-size: 13px; color:#64748b; }
  .pad-mob   { padding-left: .75rem; padding-right: .75rem; }
  .tile-mob  { min-height: 84px; }
}

@media (max-width: 640px){
  .topbar { padding:.5rem .5rem; }
}


@media (max-width: 640px){
  .dash-grid { grid-template-columns: 1fr !important; gap: .5rem !important; }
  .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .table-wrap table { min-width: 620px; }  
}

@media (max-width: 640px){
  .ios-input--sm{ height: 34px; font-size: 12px; }
  .ios-btn--sm{ height: 34px; font-size: 13px; }
}
/* Dashboard aesthetic improvements */
#tileGreen { background: linear-gradient(135deg,#16A34A,#22C55E); }
#tileYellow{ background: linear-gradient(135deg,#EAB308,#FACC15); }
#tileRed   { background: linear-gradient(135deg,#DC2626,#F87171); }

.shadow-md { box-shadow: 0 3px 8px rgba(0,0,0,.1); }
.rounded-2xl { border-radius: 1rem; }

@media (max-width: 640px){
  #actionStatusWrap {
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }
  #actionStatusWrap > div {
    min-height: 100px !important;
  }
}
@media (max-width: 640px){
  .area-table-wrap {
    padding-left: 0.25rem;
    padding-right: 0.25rem;
  }
  .area-table-wrap table{
    font-size: 12px;
  }
}
    /* ===== MOBILE LAYOUT (<= 1024px) ===== */
@media (max-width:1024px){

  /* flex หลักของ app ให้เป็น block บนมือถือ
     เพื่อไม่ให้ main ถูกดันไปด้านขวาโดย sidebar */
  #appShell > .flex{
    display:block;
  }

  /* overlay มืด ๆ หลังเมนู */
  .overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.45);
    backdrop-filter:blur(2px);
    z-index:30;
    display:none;
  }
  .overlay.show{
    display:block;
  }
}
  </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<body class="bg-gradient-to-br from-emerald-50 via-teal-50 to-sky-50 min-h-screen">

<!-- =================== LOGIN =================== -->
<section id="loginPage" class="login-wrap">
  <div class="login-card relative">

    <!-- โลโก้เด่นด้านบน (ลอยออกจากการ์ด) -->
    <div class="login-hero">
      <div class="login-logo">
        <img src="ESAPlogo.png" alt="logo">
      </div>
    </div>

    <!-- ชื่อโปรเจกต์ -->
    <h1 class="login-title">Executive Store Adopter</h1>
    <p class="login-sub">เข้าสู่ระบบเพื่อดูผลประเมินและกรอก Action</p>

    <!-- สิทธิ์ -->
    <div class="login-field">
      <div class="text-xs text-emerald-700 mb-1">สิทธิ์ที่เข้าถึง</div>

      <div class="role-seg">
        <div>
          <input type="radio" name="role" id="r_head" value="HEAD" checked>
          <label for="r_head" class="role-btn">
            <svg class="w-5 h-5 text-emerald-600" viewBox="0 0 24 24" fill="none">
              <path d="M12 3l7 4v6a8 8 0 01-7 8 8 8 0 01-7-8V7l7-4z" stroke="currentColor" stroke-width="1.5"/>
            </svg>
            <span>Format Head</span>
          </label>
        </div>

        <div>
          <input type="radio" name="role" id="r_vp" value="VP">
          <label for="r_vp" class="role-btn">
            <svg class="w-4 h-4 text-emerald-600" viewBox="0 0 24 24" fill="none">
              <path d="M12 3l3 6 6 .9-4.5 4.1L18 21l-6-3.2L6 21l1.5-7L3 9.9 9 9l3-6Z" stroke="currentColor" stroke-width="1.5"/>
            </svg>
            <span>VP-DM</span>
          </label>
        </div>

        <div>
          <input type="radio" name="role" id="r_sgm" value="SGM">
          <label for="r_sgm" class="role-btn">
            <svg class="w-4 h-4 text-emerald-600" viewBox="0 0 24 24" fill="none">
              <path d="M12 6a4 4 0 110 8 4 4 0 010-8Zm-7 14a7 7 0 1114 0H5Z" stroke="currentColor" stroke-width="1.5"/>
            </svg>
            <span>SGM-SM</span>
          </label>
        </div>
      </div>
    </div>

    <!-- ช่องรหัส & ปุ่ม -->
    <div class="login-field">
      <div class="text-xs text-emerald-700 mb-1">รหัสผ่าน</div>
      <input id="code" class="w-full border border-emerald-200 ios-input--lg"
             placeholder="รหัสผ่านของท่าน" />
    </div>

    <div class="login-field">
      <button id="btnLogin" class="btn-login">เข้าสู่ระบบ</button>
    </div>

    <p id="loginInfo" class="login-foot">หากมีปัญหาเข้าสู่ระบบ โปรดติดต่อคุณวาโย theerapat.pon@bigc.co.th </p>
  </div>
</section>


<!-- =================== APP =================== -->
<section id="appShell" class="hidden">
  <div id="sbOverlay" class="overlay"></div>

  <!-- Success Sheet -->
  <div id="saveSuccess" class="fixed inset-0 hidden z-50">
    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 text-center">
        <div class="mx-auto mb-3 w-14 h-14 rounded-full bg-emerald-100 flex items-center justify-center">
          <svg viewBox="0 0 24 24" class="w-8 h-8 text-emerald-600"><path d="M5 13l4 4L19 7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </div>
        <div class="text-xl font-bold text-slate-900">บันทึกทั้งหมดสำเร็จ</div>
        <div class="text-slate-600 mt-1">จำนวน <span id="succ_count">0</span> รายการ</div>
        <div class="mt-4">
          <button id="succ_close" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">ปิด</button>
        </div>
      </div>
    </div>
  </div>

  <div class="flex">
    <!-- Sidebar -->
    <aside id="sidebar"
  class="sidebar shrink-0 bg-white border-r">
      <div class="p-4 flex items-center gap-3 border-b">
        <img src="ESAPlogo.png" class="logo-wide" style="height:32px" alt="logo">
        <div>
          <div class="font-bold text-slate-900">Executive Store Adopter</div>
          <div id="whoami" class="text-xs text-slate-600">—</div>
        </div>
      </div>
      <nav class="p-2">
        <button data-tab="tabDashboard" class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 font-medium">
          <svg class="w-5 h-5 text-emerald-600" viewBox="0 0 24 24" fill="none"><path d="M3 12h8V3H3v9Zm10 9h8V12h-8v9ZM3 21h8v-7H3v7Zm10-18v7h8V3h-8Z" stroke="currentColor" stroke-width="1.5"/></svg>
          Dashboard
        </button>
        <button data-tab="tabStore" class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 font-medium">
          <svg class="w-5 h-5 text-sky-600" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M6 7v13h12V7M9 3h6" stroke="currentColor" stroke-width="1.5"/></svg>
          ผลประเมินสาขา
        </button>
        <button data-tab="tabAdopter" class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 font-medium">
          <svg class="w-5 h-5 text-violet-600" viewBox="0 0 24 24" fill="none"><path d="M12 6a4 4 0 110 8 4 4 0 010-8Zm-7 14a7 7 0 1114 0H5Z" stroke="currentColor" stroke-width="1.5"/></svg>
          ประเมิน Adopter
        </button>
        <button id="btnLogout" class="w-full mt-2 flex items-center gap-3 px-3 py-2 rounded-lg bg-rose-50 text-rose-700 hover:bg-rose-100 font-medium">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M16 17l5-5-5-5M21 12H9M13 7V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h6a2 2 0 002-2v-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          ออกจากระบบ
        </button>
      </nav>
    </aside>

    <!-- MAIN -->
   <main class="flex-1 min-h-screen w-full overflow-x-hidden">
      <!-- Top bar -->
      <div class="flex items-center justify-between p-3 bg-white/80 backdrop-blur sticky top-0 z-30 border-b topbar">
 <div class="flex items-center gap-2">
          <button id="btnHamburger" class="p-2 rounded-lg border text-slate-700 hover:bg-slate-50" title="เมนู">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
              <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="font-semibold text-slate-900">Executive Store Adopter</div>
        </div>

        <!-- ขวา: Export + SaveAll (id ต้องไม่ซ้ำ) -->
        <div class="flex items-center gap-2">
          <div class="relative">
            <button id="btnExport" class="p-2 rounded-lg border hover:bg-slate-50" title="ดาวน์โหลด/พิมพ์">
              <svg viewBox="0 0 24 24" class="w-5 h-5">
                <path d="M12 3v12m0 0l-4-4m4 4l4-4M5 21h14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div id="exportMenu" class="hidden absolute right-0 mt-2 w-64 bg-white border rounded-xl shadow-lg z-50">
              <button data-export="print" class="w-full text-left px-3 py-2 hover:bg-slate-50">Print PDF</button>
              <button data-export="csv" class="w-full text-left px-3 py-2 hover:bg-slate-50">CSV</button>
              <button data-export="excel" class="w-full text-left px-3 py-2 hover:bg-slate-50">Excel</button>
<button data-export="import" id="btnImportExcel" class="w-full text-left px-3 py-2 hover:bg-slate-50">
  Import Excel
</button>
<input type="file" id="excelInput" accept=".xlsx" class="hidden" />
            </div>
          </div>
          <button id="btnSaveAllTop" disabled class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white opacity-40">
            บันทึกทั้งหมด
          </button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <section id="tabDashboard" class="p-4">
        <h2 class="text-xl font-bold text-slate-900 mb-3">Dashboard</h2>

       <!-- === ROUND RESULT TILES === -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
  <div id="tileGreen"  class="rounded-2xl p-4 text-white shadow-md bg-[#16A34A]">
    <div class="text-lg font-semibold">Green</div>
    <div class="text-3xl font-bold mt-1" id="greenCount">11</div>
  </div>

  <div id="tileYellow" class="rounded-2xl p-4 text-white shadow-md bg-[#FACC15]">
    <div class="text-lg font-semibold">Yellow</div>
    <div class="text-3xl font-bold mt-1" id="yellowCount">10</div>
  </div>

  <div id="tileRed" class="rounded-2xl p-4 text-white shadow-md bg-[#DC2626]">
    <div class="text-lg font-semibold">Red</div>
    <div class="text-3xl font-bold mt-1" id="redCount">2</div>
  </div>
</div>

    <!-- ACTION STATUS SECTION -->
<section class="mt-6">
  <h3 class="text-base font-semibold text-slate-700 mb-3">Action Status</h3>
  <div id="actionStatusWrap" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <div id="stDone"></div>
    <div id="stInProg"></div>
    <div id="stSent"></div>
    <div id="stNone"></div>
  </div>
</section>


        <!-- Round scores by store -->
        <div class="glass border border-white/60 rounded-2xl p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="font-semibold text-slate-900">คะแนน 3 รอบของสาขา</div>
            <div class="text-xs text-slate-500" id="roundScoreNote">กรอง/เลือกให้เหลือ 1 สาขาเพื่อดูคะแนน</div>
          </div>
          <div id="tileRoundWrap" class="table-wrap"></div>
</div>
      </section>

      <!-- STORE -->
      <section id="tabStore" class="hidden">
        <!-- Sticky filters -->
        <div class="sticky top-[56px] z-20 bg-white/70 backdrop-blur border-b">
          <div class="px-3 py-2">
            <div class="liquid p-2">
              <div class="text-[11px] font-semibold text-slate-600 mb-1">Filters</div>

              <div class="flex flex-wrap items-end gap-2 overflow-x-auto no-scrollbar py-1 filters-row">
                <label class="block min-w-[120px]">
                  <span class="block text-[11px] text-slate-500 mb-0.5">Round</span>
                  <select id="f_round" class="ios-input ios-input--sm w-full"></select>
                </label>
    <label class="block min-w-[159px]">
  <span class="block text-[10px] text-slate-500 mb-0.5">VP</span>
  <select id="f_vp" class="ios-input ios-input--sm w-full"></select>
</label>
                <label class="block min-w-[180px]">
                  <span class="block text-[11px] text-slate-500 mb-0.5">Area</span>
                  <select id="f_area" class="ios-input ios-input--sm w-full"></select>
                </label>
  
                <label class="block min-w-[200px]">
                  <span class="block text-[11px] text-slate-500 mb-0.5">Topic</span>
                  <select id="f_topic" class="ios-input ios-input--sm w-full"></select>
                </label>

                <label class="block min-w-[140px]">
                  <span class="block text-[11px] text-slate-500 mb-0.5">Result</span>
                  <select id="f_result" class="ios-input ios-input--sm w-full">
                    <option value="">ทั้งหมด</option>
                    <option>Green</option>
                    <option>Yellow</option>
                    <option>Red</option>
                  </select>
                </label>

                <label class="block min-w-[220px]">
                  <span class="block text-[11px] text-slate-500 mb-0.5">Store</span>
                  <input id="f_store" class="ios-input ios-input--sm w-full" placeholder="รหัสหรือชื่อสาขา">
                </label>

                <div class="flex items-end gap-2 ml-auto pr-1">
                  <button id="btnSearch" class="ios-btn ios-btn--sm bg-sky-600 hover:bg-sky-700 text-white">ค้นหา</button>
                  <button id="btnReset"  class="ios-btn ios-btn--sm border bg-white hover:bg-slate-50">รีเซ็ต</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AREA -> TOPIC -> QUESTION -->
        <div class="p-4 space-y-6" id="areaContainers"></div>
        <div class="px-4 pb-4 text-xs text-slate-500" id="lastSaved">—</div>
      </section>

      <!-- ADOPTER -->
<section id="tabAdopter" class="p-4">
  <div class="max-w-xl mx-auto bg-white border rounded-2xl shadow-sm p-6 text-center">
    <h2 class="text-xl md:text-2xl font-bold mb-3">ประเมิน Adopter</h2>
    <p class="text-sm text-slate-600 mb-4">กดปุ่มด้านล่างเพื่อไปยังหน้าประเมิน</p>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSe8rJwx-Dzp2m_X0SV2DLkoRJ8eYURTnL_R8KNNg6Qyat9l1Q/viewform" target="_blank" rel="noopener"
       class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-violet-600 text-white hover:bg-violet-700">
      เปิดแบบประเมิน Adopter
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
        <path d="M7 17L17 7M10 7h7v7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
      </svg>
    </a>
  </div>
</section>

  <!-- Sticky save (future batch) -->
  <div id="saveBar" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 glass border border-white/60 rounded-2xl shadow-xl px-4 py-3 flex items-center gap-3">
    <div class="text-sm text-slate-700">
      <span id="dirtyCount">0</span> รายการพร้อมบันทึก
    </div>
    <button id="btnSaveAll" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl font-semibold">
      บันทึกทั้งหมด
    </button>
  </div>
</section>

<!-- Loader -->
<div id="loader">
  <div class="loader-box">
    <div class="spinner"></div>
    <div class="text-slate-700 text-sm">กำลังประมวลผล...</div>
  </div>
</div>

<!-- Popup: Comment (read-only) + Action (scrollable) -->
<div id="actionModal" class="modal" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="panel">
    <div class="card">
      <div class="head">
        <div class="space-y-2">
          <div class="text-xs text-slate-500">รายละเอียด (รอบที่ <span id="am_round">-</span>)</div>
          <div class="meta-row">
            <div class="meta-item">
              <span class="label">Store:</span>
              <span id="am_meta_store" class="text" title=""></span>
            </div>
            <div class="meta-item">
              <span class="label">Topic:</span>
              <span id="am_meta_topic" class="text" title=""></span>
            </div>
            <div class="meta-item">
              <span class="label">Question:</span>
              <span id="am_meta_question" class="text" title=""></span>
            </div>
          </div>
        </div>
        <button class="icon-btn" id="am_close" title="ปิด">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>

      <div id="am_body" class="body space-y-5">
        <section>
          <div class="text-xs text-slate-500 mb-1">Comment (อ่านอย่างเดียว / รอบนี้)</div>
          <div id="am_comment_ro"
               class="whitespace-pre-wrap rounded-lg border bg-slate-50 p-3 leading-relaxed text-[15px] text-slate-700 min-h-[56px]">—</div>
        </section>

        <section>
          <div class="text-xs text-slate-500 mb-2">Action</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="block">
              <span class="text-xs text-slate-500">Reason</span>
              <textarea id="am_reason" class="mt-1 w-full border rounded-lg p-2 min-h-[96px]"></textarea>
            </label>
            <label class="block">
              <span class="text-xs text-slate-500">Action</span>
              <textarea id="am_action" class="mt-1 w-full border rounded-lg p-2 min-h-[96px]"></textarea>
            </label>
            <label class="block">
              <span class="text-xs text-slate-500">Assign</span>
              <select id="am_assign" class="mt-1 w-full border rounded-lg p-2"></select>
            </label>
            <div class="grid grid-cols-2 gap-4">
              <label class="block">
                <span class="text-xs text-slate-500">Status</span>
                <select id="am_status" class="mt-1 w-full border rounded-lg p-2">
                  <option>Sent BU</option>
                  <option>In progress</option>
                  <option>Done</option>
                </select>
              </label>
              <label class="block">
                <span class="text-xs text-slate-500">Due</span>
                <input id="am_due" type="date" class="mt-1 w-full border rounded-lg p-2">
              </label>
            </div>
          </div>
        </section>
      </div>

      <div class="foot flex items-center justify-between">
        <div class="text-xs text-slate-500">* บันทึกอัตโนมัติ • Action ผูกระดับ Question</div>
        <div class="flex items-center gap-2">
          <button id="am_ok" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">ตกลง</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Summary Modal -->
<div id="summaryModal" class="modal" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="panel">
    <div class="card">
      <div class="head">
        <div>
          <div class="font-semibold text-slate-900">รายการที่ยังไม่ Done</div>
          <div id="sm_title" class="text-xs text-slate-500">—</div>
        </div>
        <button class="icon-btn" id="sm_close" title="ปิด">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="body">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-50"><tr>
              <th class="px-3 py-2 text-left">Store</th>
              <th class="px-3 py-2 text-left">Area</th>
              <th class="px-3 py-2 text-left">Topic</th>
              <th class="px-3 py-2 text-left">Question</th>
              <th class="px-3 py-2">Answer</th>
              <th class="px-3 py-2">Status</th>
            </tr></thead>
            <tbody id="sm_rows"></tbody>
          </table>
        </div>
      </div>
      <div class="foot flex items-center justify-between">
        <div id="sm_count" class="text-xs text-slate-500">—</div>
        <button id="sm_ok" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">ปิด</button>
      </div>
    </div>
  </div>
</div>

<!-- Status Modal -->
<div id="statusModal" class="modal" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="panel">
    <div class="card">
      <div class="head">
        <div>
          <div class="font-semibold text-slate-900">รายละเอียดตาม Action Status</div>
          <div id="stm_title" class="text-xs text-slate-500">—</div>
        </div>
        <button class="icon-btn" id="stm_close" title="ปิด">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="body">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-50"><tr>
              <th class="px-3 py-2 text-left">Store</th>
              <th class="px-3 py-2 text-left">Area</th>
              <th class="px-3 py-2 text-left">Question</th>
              <th class="px-3 py-2 text-center">Answer</th>
              <th class="px-3 py-2 text-center">Status</th>
            </tr></thead>
            <tbody id="stm_rows"></tbody>
          </table>
        </div>
      </div>
      <div class="foot flex items-center justify-between">
        <div id="stm_count" class="text-xs text-slate-500">—</div>
        <button id="stm_ok" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">ปิด</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
/* ใส่ Web App URL (ลงท้ายด้วย /exec) ของ GAS ที่เพิ่ง Deploy */
const API_BASE = 'https://script.google.com/macros/s/AKfycbytiY6g8a_-P5VVjvVMPj8Mc0hXrN6geTlh7VSd8OJ5OgTC0UsbSnSi-LR_JNXBWgTbwA/exec';

/* ========= STATE ========= */
let TOKEN='', SESSION=null;
let ALL_ITEMS=[];
let REFNO_BY_ROUND={}, CURRENT_REFNO='', CURRENT_ROUND='';
const CHANGES = new Map();

let AM_CTX = null; // {refno,key,topic,question,actionid,round,currentAction,currentComment,storeCode}
const qs  = id=>document.getElementById(id);
const show= (el,on)=> el.classList[on?'remove':'add']('hidden');

let __LOADING_COUNT = 0;
function loading(on){
  if(on){ __LOADING_COUNT++; }
  else{ __LOADING_COUNT = Math.max(0, __LOADING_COUNT - 1); }
  const el = qs('loader');
  if (el) el.classList.toggle('show', __LOADING_COUNT > 0);
}


/* ========= NAV TABS ========= */
const setActiveTab = (tabId)=>{
  ['tabDashboard','tabStore','tabAdopter'].forEach(id=>qs(id).classList.add('hidden'));
  qs(tabId).classList.remove('hidden');
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.classList.toggle('bg-slate-100', btn.dataset.tab===tabId);
  });
};

let LOAD_GEN = 0; // รุ่นของงานโหลดล่าสุด (กันผลตอบกลับเก่ามาทับใหม่)

const CACHE_KEY = ()=> `ss-cache-${SESSION?.role||''}-${SESSION?.code||''}`;
function loadCacheItems() {
  try {
    const raw = sessionStorage.getItem(CACHE_KEY());
    if (!raw) return null;
    const j = JSON.parse(raw);
    return Array.isArray(j.items) ? j.items : null;
  } catch(_) { return null; }
}
function saveCacheItems(items) {
  try { sessionStorage.setItem(CACHE_KEY(), JSON.stringify({ ts: Date.now(), items })); } catch(_){}
}

function getActionId(obj){
  if (!obj || typeof obj !== 'object') return '';
  const keys = ['actionid','action_id','actionId','actionID'];
  for (const k of keys) {
    if (obj[k] != null && obj[k] !== '') return String(obj[k]);
  }
  const nested = obj.action || obj.actions || obj._action || (obj.payload && obj.payload.action) || obj.payload;
  if (Array.isArray(nested) && nested.length) return getActionId(nested[0]);
  if (nested && typeof nested === 'object') {
    for (const k of keys) {
      if (nested[k] != null && nested[k] !== '') return String(nested[k]);
    }
    if (nested.meta && typeof nested.meta === 'object') {
      for (const k of keys) {
        if (nested.meta[k] != null && nested.meta[k] !== '') return String(nested.meta[k]);
      }
    }
  }
  if (obj.payload && (obj.payload.actionId || obj.payload.action_id)) return String(obj.payload.actionId ?? obj.payload.action_id);
  return '';
}

/* ========= API ========= */
// helper: หน่วงเวลา (ไว้ทำ backoff)

const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));

async function apiGet(endpoint, params = {}, opt = {}) {
  // timeout ปกติ 120 วิ + รีทราย 2 ครั้ง (ปรับได้ตอนเรียก)
  const { timeoutMs = 120000, retries = 2, retryDelayMs = 1500 } = opt;
  const q = new URLSearchParams({ endpoint, token: TOKEN, ...params }).toString();

  let attempt = 0;
  while (true) {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);

    try {
      const res = await fetch(`${API_BASE}?${q}`, {
        method: 'GET',
        cache: 'no-store',
        credentials: 'omit',
        signal: ctrl.signal
      });
      clearTimeout(t);
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status} ${res.statusText} ${text.slice(0,200)}`);
      }
      return await res.json();
    } catch (e) {
      clearTimeout(t);
      if (attempt < retries) {
        attempt++;
        await sleep(retryDelayMs * attempt); // backoff
        continue;
      }
      if (e.name === 'AbortError') {
        throw new Error(`API timeout: ใช้เวลานานเกิน ${Math.floor(timeoutMs/1000)} วินาที`);
      }
      throw new Error('Network/CORS error (Fail to fetch). กรุณาตรวจสอบการตั้งค่า API และสิทธิ์เข้าถึง');
    }
  }
}


// รันลิสต์งานแบบจำกัดจำนวนคำขอพร้อมกัน
async function runWithConcurrency(tasks, limit = 3) {
  const results = new Array(tasks.length);
  let idx = 0;

  async function worker() {
    while (true) {
      const i = idx++;
      if (i >= tasks.length) break;
      results[i] = await tasks[i]();
    }
  }

  const workers = Array.from({ length: Math.min(limit, tasks.length) }, () => worker());
  await Promise.all(workers);
  return results;
}

// ทำ batch re-render กัน DOM กระตุก
function makeRafBatcher(fn, minGap=500){
  let scheduled = false, last = 0;
  return function(){
    const now = Date.now();
    if (scheduled) return;
    const wait = Math.max(0, minGap - (now - last));
    scheduled = true;
    setTimeout(()=> {
      requestAnimationFrame(()=> {
        scheduled = false; last = Date.now(); fn();
      });
    }, wait);
  };
}


// ===== THEME: สีหัวการ์ดตามชื่อ Area (คงที่/สม่ำเสมอ) =====
const AREA_PALETTE = [
  { bg:'#0ea5e9', bd:'#0284c7' }, // sky
  { bg:'#10b981', bd:'#059669' }, // emerald
  { bg:'#f59e0b', bd:'#d97706' }, // amber
  { bg:'#ef4444', bd:'#dc2626' }, // red
  { bg:'#6366f1', bd:'#4f46e5' }, // indigo
  { bg:'#8b5cf6', bd:'#7c3aed' }, // violet
  { bg:'#14b8a6', bd:'#0d9488' }, // teal
  { bg:'#84cc16', bd:'#65a30d' }, // lime
];
function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i)|0; } return Math.abs(h); }
function getAreaTheme(name){
  const p = AREA_PALETTE[ hashCode(String(name||'')) % AREA_PALETTE.length ];
  return p || AREA_PALETTE[0];
}

async function apiPost(endpoint, body = {}, opt = {}) {
  const { timeoutMs = 120000, retries = 2, retryDelayMs = 1500 } = opt;
  const url = `${API_BASE}?endpoint=${encodeURIComponent(endpoint)}&token=${encodeURIComponent(TOKEN)}`;
  let attempt = 0;
  while (true) {
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const form = new URLSearchParams();
      form.append('payload', JSON.stringify(body));
      const res = await fetch(url, { method:'POST', body: form, signal: ctrl.signal, cache:'no-store' });
      clearTimeout(t);
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      return await res.json();
    }catch(e){
      clearTimeout(t);
      if(attempt < retries){ attempt++; await sleep(retryDelayMs*attempt); continue; }
      throw e;
    }
  }
}



/* ========= LOGIN ========= */
qs('btnLogin').onclick = async ()=>{
  const role = [...document.querySelectorAll('input[name=role]')].find(r=>r.checked)?.value || 'HEAD';
  const code = (qs('code').value||'').trim();
  if(!code){
    alert('กรุณาใส่รหัส');
    return;
  }

  loading(true); // เปิด overlay ตั้งแต่ก่อนยิง API
  try{
    // 1) auth_login
    const form = new URLSearchParams({ role, code, wantMeta:'true' });
    const res = await fetch(`${API_BASE}?endpoint=auth_login`, { method:'POST', body: form });
    const json = await res.json();

    if(!json.ok){
      // กรณี backend บอกไม่พบสิทธิ์จริงๆ
      throw new Error(json.error||'เข้าสู่ระบบไม่สำเร็จ');
    }

    // 2) เก็บ session/token ทันที
    TOKEN   = json.data.token;
    SESSION = json.data;
    qs('whoami').textContent = `${role} (${code})`;

    // 3) เอา scope ที่ backend ส่งมาใช้เลย ไม่ต้องรอ buildRefnoIndex ซ้ำ
    REFNO_BY_ROUND = (SESSION.scope && (SESSION.scope.roundBuckets || SESSION.scope.roundIndex)) || {};

    // 4) bind dropdown รอบ (ใช้ REFNO_BY_ROUND ที่เรามีแล้ว)
    await buildRefnoIndex(); // ฟังก์ชันนี้ตอนนี้จะเห็น REFNO_BY_ROUND ที่เราตั้งเองแล้ว
    bindRoundOptions();

    // 5) โหลดข้อมูลหลัก (evaluation + dashboard)
    await loadEvaluations();   // จะพยายามดึง ALL_ITEMS
    await renderDashboard();   // อาจอ้าง ALL_ITEMS ด้วย

    // 6) ตรวจ condition จริง ๆ หลังโหลด
    if (!ALL_ITEMS.length){
      // ยังไม่มีข้อมูลเลย แสดงว่า scope.refnos มีปัญหา/ไม่มีสิทธิ์
      throw new Error(`ไม่พบสิทธิ์สำหรับรหัสนี้ ${code}`);
    }

    // 7) ผ่านแล้ว -> โชว์หน้าหลัก
    show(qs('loginPage'), false);
    show(qs('appShell'), true);
    setActiveTab('tabDashboard'); // บังคับเปิดหน้าหลัก Dashboard หรือผลประเมินตามที่ต้องการ

  }catch(ex){
    alert(ex.message || String(ex));
    // ถ้า fail ให้ปิด overlay ด้วย (spinner หาย)
  }finally{
    loading(false); // ปิด overlay ไม่ว่าผลจะสำเร็จหรือ fail
  }
};

qs('btnLogout').onclick = ()=> location.reload();

/* ========= ROUND INDEX ========= */
async function buildRefnoIndex(){
  const src = (SESSION.scope && (SESSION.scope.roundBuckets || SESSION.scope.roundIndex)) || {};
  REFNO_BY_ROUND = src;
  if (!Object.keys(REFNO_BY_ROUND).length) {
    const rsp = await apiGet('round_index');
    if (rsp.ok) REFNO_BY_ROUND = rsp.data || {};
  }
}


/* ========= BIND ROUND DROPDOWN ========= */
function bindRoundOptions(){
  const sel = qs('f_round');
  const rounds = Object.keys(REFNO_BY_ROUND);

  if (!rounds.length){
    sel.innerHTML = '<option>-</option>';
    CURRENT_ROUND = '';
    return;
  }

  sel.innerHTML = rounds.map(x=>`<option>${x}</option>`).join('');
  sel.onchange = async ()=>{
    CURRENT_ROUND = sel.value;
    CURRENT_REFNO = REFNO_BY_ROUND[CURRENT_ROUND] || CURRENT_REFNO;
    await loadEvaluations();
    await renderDashboard();
  };
  CURRENT_ROUND = rounds[0];
  sel.value = CURRENT_ROUND;
}
function uniqRefnosFromScope(){
  const out = new Set();
  const m = REFNO_BY_ROUND || {};
  Object.values(m).forEach(v=>{
    if (Array.isArray(v)) v.forEach(x => x && out.add(x));
    else if (v) out.add(v);
  });
  (SESSION?.scope?.refnos || []).forEach(x => x && out.add(x));
  return [...out];
}

async function loadEvaluations(){
  loading(true);
  const gen = ++LOAD_GEN;

  try{
    let refnos = uniqRefnosFromScope();

    // ถ้ายังไม่มี refnos ลองรอรอบสั้น ๆ เผื่อ scope เพิ่งตั้งค่า
    if (!refnos.length){
      await new Promise(r => setTimeout(r, 500));
      refnos = uniqRefnosFromScope();
    }

    // ถ้ายังไม่มี refnos ตรงนี้ "ไม่ throw" ให้ return เฉย ๆ
    if (!refnos.length){
      console.warn('ยังไม่มี refno ใน scope หลังพยายามโหลด');
      return; // <-- สำคัญ: ไม่โยน error แล้ว
    }

    // เตรียมเคลียร์ข้อมูลเก่า
    ALL_ITEMS = [];

    // จำกัด concurrency ไม่ให้หนักเกิน
    const conc = Math.max(3, Math.min(8, (navigator.hardwareConcurrency || 6) - 1));

    // เตรียม tasks สำหรับแต่ละ refno
    const tasks = refnos.map(refno => async ()=>{
      const r = await apiGet(
        'store_evaluation',
        { refno, page:1, limit:4000 },
        { timeoutMs:120000, retries:2, retryDelayMs:2000 }
      );

      if (gen !== LOAD_GEN) return r; // กัน race ถ้ามีโหลดซ้ำ

      const items = (r?.ok && r.data?.items) ? r.data.items : [];
      if (items.length){
        ALL_ITEMS.push(...items);
        renderAreaContainers();      // อัปเดตทันที (partial render)
        renderActionStatusTiles();   // อัปเดต tile status
      }
      return r;
    });

    // ดึงคู่ขนาน
    await runWithConcurrency(tasks, conc);

    // cache local เผื่อ reload tab
    saveCacheItems(ALL_ITEMS);

    // bind ตัวเลือก filter
    bindAreaTopicOptions();

    // render หน้าหลักอีกรอบ (final pass)
    renderAreaContainers();
    await renderDashboard();

  }catch(ex){
    console.error('loadEvaluations error:', ex);
    // ไม่ alert ที่นี่แล้ว ให้ login เป็นคน alert
  }finally{
    if (gen === LOAD_GEN) loading(false);
  }
}


/* ========= DASHBOARD ========= */
async function renderDashboard(){
  // กล่องสีทึบ: เขียว/เหลือง/แดง (เหลืองใช้ตัวอักษรสีดำให้อ่านง่าย)
  const tiles = [
    { id:'tileGreen',  title:'Green',  bg:'bg-emerald-600', text:'text-white',    label:'text-white/90' },
    { id:'tileYellow', title:'Yellow', bg:'bg-yellow-400',  text:'text-black',    label:'text-black/80' },
    { id:'tileRed',    title:'Red',    bg:'bg-rose-600',    text:'text-white',    label:'text-white/90' },
  ];

  const countAll = ALL_ITEMS.length;
  const cnt = (k)=> ALL_ITEMS.filter(x=> String(x.answer||'').toLowerCase().includes(k)).length;
  const data = { all: countAll, green: cnt('green'), yellow: cnt('yellow'), red: cnt('red') };

  tiles.forEach(t=>{
    const el = qs(t.id);
    el.className = `rounded-xl p-4 ${t.text} shadow ${t.bg} text-left border border-black/5`;
    const val = ( t.id==='tileGreen' ? data.green
               : t.id==='tileYellow'? data.yellow
               :                       data.red );
    el.innerHTML = `
      <div class="text-xs ${t.label}">${t.title}</div>
      <div class="text-3xl font-bold mt-1">${val}</div>
    `;
    el.onclick = null;
    el.style.cursor = 'default';
  });

  await renderRoundScoresBox();
  renderActionStatusTiles();
}



function normalizeStatus(s){
  const v = String(s ?? '').trim().toLowerCase();
  if(!v) return 'none';
  if(v === 'no action' || v === 'noaction') return 'none';

  if(v === 'done') return 'done';
  if(v === 'in progress' || v === 'inprogress') return 'inprogress';
  if(v === 'sent bu' || v === 'sent to bu' || v === 'sent') return 'sent';
  return v;
}

function renderActionStatusTiles(){
  const YR = ALL_ITEMS.filter(it=> /yellow|red/i.test(String(it.answer||'')));

  const stats = { done:0, inprogress:0, sent:0, none:0 };
  YR.forEach(it=>{
    const k = normalizeStatus(it.action?.status);
    if(k in stats) stats[k]++; else stats.none++;
  });

  const tiles = [
    { el:'stDone',   key:'done',       title:'DONE',        value:stats.done,       color:'from-emerald-600 to-emerald-500 text-white',   icon:'✔' },
    { el:'stInProg', key:'inprogress', title:'IN PROGRESS', value:stats.inprogress, color:'from-sky-600 to-sky-500 text-white',           icon:'🕒' },
    { el:'stSent',   key:'sent',       title:'SENT BU',     value:stats.sent,       color:'from-amber-500 to-amber-400 text-slate-900',   icon:'✈' },
    { el:'stNone',   key:'none',       title:'NO ACTION',   value:stats.none,       color:'from-rose-600 to-rose-500 text-white',         icon:'🚫' },
  ];

  tiles.forEach(t=>{
    const el = qs(t.el);
    el.className = `
      rounded-2xl p-4 shadow-md text-left
      bg-gradient-to-br ${t.color}
      hover:shadow-lg hover:scale-[1.02]
      transition-all duration-150 ease-in-out
      flex flex-col justify-between min-h-[120px] cursor-pointer
    `.trim();

    el.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-base font-semibold tracking-wide">${t.title}</div>
        <div class="w-9 h-9 rounded-xl bg-white/20 flex items-center justify-center text-lg">${t.icon}</div>
      </div>
      <div class="text-3xl font-bold mt-1">${t.value}</div>
      <div class="text-[11px] mt-1 underline opacity-90">คลิกเพื่อดูรายละเอียด</div>
    `;
    el.onclick = ()=> openStatusModal(t.key, t.title.replace(/\s+/g,' '));
  });
}

function openStatusModal(key, label){
  const modal = qs('statusModal');
  const tbody = qs('stm_rows');
  const title = qs('stm_title');
  const count = qs('stm_count');

  const rows = ALL_ITEMS.filter(it=>{
    const isYR = /yellow|red/i.test(String(it.answer||''));
    const k = normalizeStatus(it.action?.status);
    return isYR && ((key==='none') ? (k==='none') : (k===key));
  });

  const byArea = new Map();
  rows.forEach(it=>{
    const a = String(it.area||'-');
    if(!byArea.has(a)) byArea.set(a, []);
    byArea.get(a).push(it);
  });

  const areas = Array.from(byArea.keys()).sort((a,b)=>a.localeCompare(b, 'th'));
  title.textContent = `Status: ${label}`;
  tbody.innerHTML = '';

  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="5" class="px-3 py-6 text-center text-slate-500">ไม่มีรายการ</td></tr>`;
  }else{
    areas.forEach(area=>{
      const trH = document.createElement('tr');
      trH.innerHTML = `<td colspan="5" class="px-3 py-2 bg-slate-50 text-slate-700 font-semibold">Area: ${area}</td>`;
      tbody.appendChild(trH);

      byArea.get(area).forEach(it=>{
        const tr = document.createElement('tr');
        const store = it.storeName || it.storeCode || '';
        tr.innerHTML = `
          <td class="px-3 py-2">${store}</td>
          <td class="px-3 py-2">${it.area||''}</td>
          <td class="px-3 py-2">${it.question||''}</td>
          <td class="px-3 py-2 text-center">${it.answer||''}</td>
          <td class="px-3 py-2 text-center">${it.action?.status||''}</td>`;
        tbody.appendChild(tr);
      });
    });
  }

  count.textContent = `ทั้งหมด ${rows.length} รายการ`;
  modal.classList.add('show');
  modal.setAttribute('aria-hidden','false');

  const close = ()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); };
  qs('stm_close').onclick = close;
  qs('stm_ok').onclick = close;
  modal.querySelector('.backdrop').onclick = close;
  document.addEventListener('keydown', function esc(e){
    if(e.key==='Escape'){ close(); document.removeEventListener('keydown', esc); }
  });
}

/* ========= FILTER ========= */
qs('btnSearch').onclick = ()=> renderAreaContainers();
qs('btnReset').onclick = ()=>{
  qs('f_area').value='';
  qs('f_topic').value='';
  qs('f_result').value='';
  qs('f_store').value='';
  renderAreaContainers();
};

const norm = s => String(s||'').trim().toLowerCase();

function uniqueSorted(list){
  const s = new Set();
  list.forEach(v => { const t = String(v??'').trim(); if(t) s.add(t); });
  return Array.from(s).sort((a,b)=> a.localeCompare(b,'th'));
}
function fillSelect(sel, values, placeholder='ทั้งหมด'){
  sel.innerHTML = `<option value="">${placeholder}</option>` +
                  values.map(v=>`<option>${v}</option>`).join('');
}
function bindAreaTopicOptions(){
  const selArea  = qs('f_area');
  const selVP    = qs('f_vp');
  const selTopic = qs('f_topic');

  // === เติมค่า Area ===
  const areas = uniqueSorted(ALL_ITEMS.map(x=>x.area));
  fillSelect(selArea, areas, 'ทั้งหมด');

  // === เติมค่า VP (ดึงจาก region) ===
  const vps = uniqueSorted(ALL_ITEMS.map(x=>x.region)); // <-- ต้องมี region ใน items
  fillSelect(selVP, vps, 'ทั้งหมด');

  // === เติม Topic ให้สัมพันธ์กับ Area (และ VP ถ้าเลือก) ===
  const refreshTopics = ()=>{
    const areaV = norm(selArea.value);
    const vpV   = norm(selVP.value);
    const base  = ALL_ITEMS.filter(x=>{
      const okA = !areaV || norm(x.area)   === areaV;
      const okV = !vpV   || norm(x.region) === vpV;
      return okA && okV;
    });
    const topics = uniqueSorted(base.map(x=>x.topic));
    fillSelect(selTopic, topics, 'ทั้งหมด');
  };

  // เริ่มต้น
  refreshTopics();

  // Events
  selArea.onchange  = ()=>{ refreshTopics(); renderAreaContainers(); };
  selVP.onchange    = ()=>{ refreshTopics(); renderAreaContainers(); };
  selTopic.onchange = ()=>{ renderAreaContainers(); };
}
function filteredItems(ignoreResult=false){
  const areaSel  = norm(qs('f_area').value);
  const vpSel    = norm(qs('f_vp').value);     // <-- เพิ่มบรรทัดนี้
  const topicSel = norm(qs('f_topic').value);
  const result   = norm(qs('f_result').value);
  const storeQ   = norm(qs('f_store').value);

  return ALL_ITEMS.filter(it=>{
    const okA = !areaSel  || norm(it.area)    === areaSel;
    const okV = !vpSel    || norm(it.region)  === vpSel; // <-- กรองด้วย region
    const okT = !topicSel || norm(it.topic)   === topicSel;
    const okS = !storeQ   || norm(it.storeCode).includes(storeQ) || norm(it.storeName).includes(storeQ);
    const okR = ignoreResult || !result || norm(it.answer).includes(result);
    return okA && okV && okT && okS && okR;
  });
}
/* ========= SMALL HELPERS ========= */
function pill(ans){
  const a = String(ans||'').toLowerCase();
  if(/green/.test(a)){
    return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-500 text-white" title="Green">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    </span>`;
  }
  if(/yellow/.test(a)){
    return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full" style="background:#FFFF00;color:#000" title="Yellow">Yellow</span>`;
  }
  if(/red/.test(a)){
    return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-rose-600 text-white" title="Red">Red</span>`;
  }
  return `<span class="text-slate-400">-</span>`;
}
function anyYellowRed(roundAns){
  const v = [roundAns[1], roundAns[2], roundAns[3]].map(x=>String(x||'').toLowerCase());
  if(v.some(a=>/red/.test(a))) return 'red';
  if(v.some(a=>/yellow/.test(a))) return 'yellow';
  return '';
}

/* ========= IMAGES ========= */
function normalizeImageUrl(u){
  if(!u) return '';
  try{
    const url = new URL(u);
    const host = url.hostname;
    if(host.includes('drive.google.com')){
      const m = u.match(/\/file\/d\/([^/]+)\//);
      const id = m?.[1] || url.searchParams.get('id');
      if(id) return `https://drive.google.com/uc?export=view&id=${id}`;
    }
    if(host.includes('dropbox.com')){
      url.searchParams.set('raw','1'); url.searchParams.delete('dl');
      return url.toString();
    }
    return u;
  }catch(_){ return u; }
}

/* ========= ROUNDS SCORE BOX ========= */
function fmtPct(v){
  if (v==null || v==='-' || v==='') return '-';
  const s = String(v).trim();
  if (s.endsWith('%')) return s;
  const n = Number(s);
  return Number.isFinite(n) ? n.toFixed(1)+'%' : s;
}

async function renderRoundScoresBox(){
  const host = qs('tileRoundWrap');
  host.innerHTML = '';
  const note = qs('roundScoreNote');

  // สร้าง mapping storeCode -> storeName จาก ALL_ITEMS
  const nameMap = new Map();
  ALL_ITEMS.forEach(x=>{
    const sc = String(x.storeCode||'').trim();
    const sn = String(x.storeName||'').trim();
    if(sc && sn && !nameMap.has(sc)) nameMap.set(sc, sn);
  });

  // รายการสาขาที่มีสิทธิ์
  const stores = (SESSION?.scope?.stores?.length
    ? SESSION.scope.stores
    : Array.from(new Set(ALL_ITEMS.map(x=>x.storeCode).filter(Boolean)))
  ).sort((a,b)=> String(a).localeCompare(String(b),'th',{numeric:true}));

  note.textContent = `สรุปคะแนน 3 รอบของทุกสาขาที่คุณมีสิทธิ์ดู (${stores.length} สาขา)`;

  // ไม่มีสาขา
  if(!stores.length){
    host.className = '';
    host.innerHTML = `
      <div class="rounded-xl border bg-white p-4 text-slate-600">ไม่มีสาขาในสิทธิ์</div>
    `;
    return;
  }

  // ดึงคะแนนแบบ bulk: ได้ { [storeCode]: { score:{1,2,3}, ... } }
  const rsp = await apiGet('round_scores_bulk', { codes: stores.join(',') }, { timeoutMs: 60000, retries: 1 });
  const map = (rsp.ok && rsp.data) ? rsp.data : {};

  // เปลี่ยน container เป็นตาราง (แทน grid เดิม)
  host.className = '';
  host.innerHTML = `
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-slate-50 text-slate-700">
          <tr>
            <th class="px-3 py-2 text-left">Store Code</th>
            <th class="px-3 py-2 text-left">Store Name</th>
            <th class="px-3 py-2 text-center">Round 1</th>
            <th class="px-3 py-2 text-center">Round 2</th>
            <th class="px-3 py-2 text-center">Round 3</th>
          </tr>
        </thead>
        <tbody id="rsb_rows" class="[&>tr:nth-child(even)]:bg-slate-50/60"></tbody>
      </table>
    </div>
  `;

  const tbody = host.querySelector('#rsb_rows');
  const safe = (v)=> v==null ? '-' : v;
  stores.forEach(sc=>{
    const rec = map[sc] || { score:{1:'-',2:'-',3:'-'} };
    const sn  = nameMap.get(sc) || '';
    const r1  = fmtPct(rec.score?.[1]);
    const r2  = fmtPct(rec.score?.[2]);
    const r3  = fmtPct(rec.score?.[3]);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-3 py-2 font-semibold text-slate-900">${safe(sc)}</td>
      <td class="px-3 py-2 text-slate-700">${safe(sn)}</td>
      <td class="px-3 py-2 text-center">${safe(r1)}</td>
      <td class="px-3 py-2 text-center">${safe(r2)}</td>
      <td class="px-3 py-2 text-center">${safe(r3)}</td>
    `;
    tbody.appendChild(tr);
  });
}


function openSummaryModal(color){
  const modal = qs('summaryModal');
  const tbody = qs('sm_rows');
  const title = qs('sm_title');
  const count = qs('sm_count');

  const want = color.toLowerCase();
  const rows = ALL_ITEMS.filter(it=>{
    const ans = String(it.answer||'').toLowerCase();
    const st  = String(it.action?.status||'').toLowerCase();
    return ans.includes(want) && st !== 'done';
  });

  title.textContent = `สี ${color} • รายการที่ Action Status ยังไม่ Done`;
  tbody.innerHTML = '';
  if (!rows.length){
    tbody.innerHTML = `<tr><td colspan="6" class="px-3 py-6 text-center text-slate-500">ไม่มีรายการค้าง</td></tr>`;
  }else{
    rows.forEach(it=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-3 py-2">${it.storeCode||''}</td>
        <td class="px-3 py-2">${it.area||''}</td>
        <td class="px-3 py-2">${it.topic||''}</td>
        <td class="px-3 py-2">${it.question||''}</td>
        <td class="px-3 py-2 text-center">${it.answer||''}</td>
        <td class="px-3 py-2 text-center">${it.action?.status||''}</td>`;
      tbody.appendChild(tr);
    });
  }
  count.textContent = `ทั้งหมด ${rows.length} รายการ`;
  modal.classList.add('show'); modal.setAttribute('aria-hidden','false');

  const close = ()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); };
  qs('sm_close').onclick = close;
  qs('sm_ok').onclick = close;
  modal.querySelector('.backdrop').onclick = close;
  document.addEventListener('keydown', function esc(e){ if(e.key==='Escape'){ close(); document.removeEventListener('keydown', esc);} });
}

/* Carousel 3 รูป/หน้าในแถว */
function buildRowAttach(host, images){
  if (!host) return;
  host.innerHTML = '';
  const wrap = document.createElement('div');
  wrap.className = 'row-att';

  const grid = document.createElement('div');
  grid.className = 'grid3';
  wrap.appendChild(grid);

  const nav = document.createElement('div');
  nav.className = 'nav';
  const btnPrev = document.createElement('button'); btnPrev.className='icon-btn';
  btnPrev.innerHTML = `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
  const pageLbl = document.createElement('span'); pageLbl.className='page';
  const btnNext = document.createElement('button'); btnNext.className='icon-btn';
  btnNext.innerHTML = `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
  nav.append(btnPrev,pageLbl,btnNext);

  let page=0, size=3;

  function render(){
    grid.innerHTML = '';
    const totalPages = Math.max(1, Math.ceil(images.length/size));
    const start = page*size;
    const slice = images.slice(start,start+size);

    if(slice.length===0){
      grid.innerHTML = `<div class="text-[10px] text-slate-400 col-span-3">ไม่มีรูปแนบ</div>`;
      nav.style.display='none';
      return;
    }

    slice.forEach(src=>{
      const a = document.createElement('a'); a.href=src; a.target='_blank'; a.rel='noopener';
      const img = document.createElement('img'); img.alt='attach'; img.loading='lazy';
      img.src = src;
      img.addEventListener('error', ()=>{
        a.textContent = 'เปิดลิงก์';
        a.className = 'text-[11px] underline text-slate-600 flex items-center justify-center h-16 border rounded';
      });
      a.appendChild(img);
      grid.appendChild(a);
    });

    pageLbl.textContent = `${Math.min(page+1,totalPages)}/${totalPages}`;
    btnPrev.disabled = page<=0;
    btnNext.disabled = page>=totalPages-1;
    nav.style.display = images.length>size ? 'flex' : 'none';
  }

  btnPrev.onclick = ()=>{ if(page>0){ page--; render(); } };
  btnNext.onclick = ()=>{ const totalPages = Math.ceil(images.length/size)||1; if(page<totalPages-1){ page++; render(); } };

  host.append(wrap,nav);
  render();
}

/* ========= PIVOT ========= */
function pivotByQuestionAcrossRounds(items){
  const map = new Map();
  for (const it of items){
    const area = it.area||''; 
    const topic = it.topic||''; 
    const question = it.question||''; 
    const storeCode = it.storeCode||''; 
    const storeName = it.storeName||'';
    const round = Number(it.round||-1);        // round จริงในตารางคือ 1,2,3
    const key = `${area}||${topic}||${question}||${storeCode}`;

    if(!map.has(key)){
      map.set(key, {
        key, area, topic, question, storeCode, storeName,
        roundAns:{1:null,2:null,3:null},       // ✅ ใช้ 1,2,3
        roundRaw:{1:null,2:null,3:null},
        action: it.action||null,
        actionId: getActionId(it),
        refno: it.refno||'',
      });
    }
    const row = map.get(key);

    if (round===1 || round===2 || round===3){  // ✅ รองรับเฉพาะ 1,2,3
      row.roundAns[round] = it.answer || null;
      row.roundRaw[round] = it;
    }

    // ✅ เลือก Action ใหม่จาก round 3 > 2 > 1
    row.action   = (row.roundRaw[3]?.action || row.roundRaw[2]?.action || row.roundRaw[1]?.action || row.action || null);
    row.actionId = getActionId(row.roundRaw[3]) || getActionId(row.roundRaw[2]) || getActionId(row.roundRaw[1]) || row.actionId;
  }
  return Array.from(map.values());
}

function groupAreaTopicQuestion(rows){
  const g = new Map();
  for (const r of rows){
    if (!g.has(r.area)) g.set(r.area, new Map());
    const tmap = g.get(r.area);
    if (!tmap.has(r.topic)) tmap.set(r.topic, new Map());
    const qmap = tmap.get(r.topic);
    if (!qmap.has(r.question)) qmap.set(r.question, []);
    qmap.get(r.question).push(r);
  }
  return g;
}

/* ========= MODAL ========= */
function canEditAction(assignVal, statusVal){
  const a = String(assignVal||'').trim().toLowerCase();
  const s = String(statusVal||'').trim().toLowerCase();
  if (s === 'sent bu' || s === 'sent to bu' || s === 'sent') return false; // ส่ง BU แล้วล็อก
  return a === 'operation'; // แก้ได้เฉพาะ Assign = Operation
}

function applyActionEditability(){
  const actionEl = qs('am_action');
  if (!actionEl) return;
  const editable = canEditAction(qs('am_assign')?.value, qs('am_status')?.value);
  actionEl.readOnly = !editable;                          // ให้เห็นแต่แก้ไม่ได้
  actionEl.classList.toggle('bg-slate-100', !editable);   // โทนเทาเมื่อถูกล็อก
  actionEl.placeholder = editable
    ? 'กรอก Action ของ Operation...'
    : 'Action ถูกล็อก (Assign ≠ Operation หรือ Status = Sent BU)';
  actionEl.title = editable ? '' :
    'Action จะกรอกได้เมื่อ Assign เป็น Operation และ Status ไม่ใช่ Sent BU';
}

function validateActionInputs(){
  const reason = qs('am_reason')?.value?.trim();
  const assign = qs('am_assign')?.value?.trim();
  if (!reason){ alert('กรุณากรอก Reason'); return false; }
  if (!assign){ alert('กรุณาเลือก Assign'); return false; }
  return true;
}

// ===== Helpers: สิทธิ์แก้ Action + Validate =====
function canEditAction(assignVal, statusVal){
  const a = String(assignVal||'').trim().toLowerCase();
  const s = String(statusVal||'').trim().toLowerCase();
  if (s === 'sent bu' || s === 'sent to bu' || s === 'sent') return false; // ส่ง BU แล้วล็อก
  return a === 'operation'; // แก้ได้เฉพาะ Assign = Operation
}

function applyActionEditability(){
  const actionEl = qs('am_action');
  if (!actionEl) return;
  const editable = canEditAction(qs('am_assign')?.value, qs('am_status')?.value);
  actionEl.readOnly = !editable;                          // ให้เห็นแต่แก้ไม่ได้
  actionEl.classList.toggle('bg-slate-100', !editable);   // โทนเทาเมื่อถูกล็อก
  actionEl.placeholder = editable
    ? 'กรอก Action ของ Operation...'
    : 'Action ถูกล็อก (Assign ≠ Operation หรือ Status = Sent BU)';
  actionEl.title = editable ? '' :
    'Action จะกรอกได้เมื่อ Assign เป็น Operation และ Status ไม่ใช่ Sent BU';
}

function validateActionInputs(){
  const reason = qs('am_reason')?.value?.trim();
  const assign = qs('am_assign')?.value?.trim();
  if (!reason){ alert('กรุณากรอก Reason'); return false; }
  if (!assign){ alert('กรุณาเลือก Assign'); return false; }
  return true;
}

// ===== Modal =====
function openActionModal(ctx){
  AM_CTX = ctx;

  const setMeta = (id, val)=>{ const el = qs(id); el.textContent = val||'-'; el.title = val||'-'; };
  setMeta('am_meta_store', ctx.storeCode);
  setMeta('am_meta_topic', ctx.topic);
  setMeta('am_meta_question', ctx.question);

  qs('am_round').textContent = ctx.round;
  qs('am_comment_ro').textContent = ctx.currentComment || '—';

  // เติมรายการ Assign (กัน null element)
  const assignEl = qs('am_assign');
  if (assignEl) assignEl.innerHTML = buildBuOptions(ctx.currentAction?.bu || '');

  qs('am_reason').value = ctx.currentAction?.reason || '';
  qs('am_action').value = ctx.currentAction?.text || '';
  qs('am_status').value = ctx.currentAction?.status || 'Sent BU';
  qs('am_due').value    = (ctx.currentAction?.dueDate||'').slice(0,10);

  // ปรับสิทธิ์แก้ Action ตามกติกาใหม่
  applyActionEditability();

  const m = qs('actionModal');
  m.classList.add('show'); m.setAttribute('aria-hidden','false');
}

function closeActionModal(){
  const m = qs('actionModal');
  m.classList.remove('show'); m.setAttribute('aria-hidden','true');
  AM_CTX=null;
}

// ปุ่มปิด/ฉากหลัง/ESC
qs('am_close').onclick = closeActionModal;
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeActionModal(); });
qs('actionModal').querySelector('.backdrop').onclick = closeActionModal;

// ===== เก็บการแก้ไขเข้า queue (เงียบถ้ายังไม่ผ่าน Reason/Assign) =====
function queueActionChange(silent = true) {
  if (!AM_CTX) return;

  const hasReason = !!qs('am_reason')?.value?.trim();
  const hasAssign = !!qs('am_assign')?.value?.trim();
  if (!hasReason || !hasAssign) {
    if (!silent) alert('กรุณากรอก Reason และเลือก Assign ก่อน');
    return;
  }

  const actionFields = {
    reason: qs('am_reason').value,
    text:   qs('am_action').value,
    bu:     qs('am_assign').value,
    status: qs('am_status').value,
    dueDate:qs('am_due').value
  };

  // ✅ ส่งทั้ง refno + context เสมอ
  const payload = {
    refno: AM_CTX.refno,
    action: actionFields,
    context: {
      topic:     AM_CTX.topic || '',
      question:  AM_CTX.question || '',
      storeCode: AM_CTX.storeCode || '',
      round:     AM_CTX.round || ''
    }
  };

  // ✅ ถ้ามี actionid ให้ส่งไปด้วย (ใช้เป็นคีย์หลักฝั่ง backend)
  if (AM_CTX.actionid) {
    payload.actionid = AM_CTX.actionid;
  }

  const changeKey = `${AM_CTX.key}|r${AM_CTX.round}|${AM_CTX.storeCode || ''}`;
  CHANGES.set(changeKey, payload);
  refreshDirty();
}

// ปุ่มตกลง: ต้องผ่าน validate ก่อนคิวบันทึก
qs('am_ok').onclick = ()=>{
  if(!validateActionInputs()) return;
  queueActionChange(false); // ไม่ silent -> ถ้าพลาดจะแจ้งเตือน
  closeActionModal();
};

// ===== Options Assign (คง logic เดิม) =====
function buildBuOptions(current){
  const pool = new Set(['Commercial','HR', 'Supply Chain', 'Maintenance', 'Town Center', 'Property', 'Wawee', 'Pure', 'Marketing']);
  ALL_ITEMS.forEach(it=>{ if(it.action?.bu) pool.add(it.action.bu); });
  return Array.from(pool).map(bu=>`<option ${bu===current?'selected':''}>${bu}</option>`).join('');
}

// ===== Listeners: เมื่อเปลี่ยนค่า -> เข้าคิว + รีเฟรชสิทธิ์แก้ Action =====
['am_reason','am_action','am_assign','am_status','am_due'].forEach(id=>{
  const el = qs(id);
  if (el) el.addEventListener('change', ()=> queueActionChange(true));
});

// เปลี่ยน Assign/Status ให้รีเฟรชสิทธิ์แก้ Action ด้วย
['am_assign','am_status'].forEach(id=>{
  const el = qs(id);
  if (el) el.addEventListener('change', applyActionEditability);
});


/* ========= RENDER ========= */
const cmpTH = (a, b) =>
  String(a ?? '').localeCompare(String(b ?? ''), 'th', { numeric: true, sensitivity: 'base' });

function renderAreaContainers(){
  const baseList   = filteredItems(true);
  let   pivotRows  = pivotByQuestionAcrossRounds(baseList);

  const resultSel = norm(qs('f_result').value);
  if (resultSel){
    pivotRows = pivotRows.filter(r =>
      [1,2,3].some(rd => norm(r.roundAns[rd]).includes(resultSel))
    );
  }

  const groups = groupAreaTopicQuestion(pivotRows);

  const host = qs('areaContainers');
  host.innerHTML = '';
  if(!pivotRows.length){
    host.innerHTML = `<div class="text-center text-slate-600 py-8">ไม่มีข้อมูลตามตัวกรอง</div>`;
    return;
  }

  const areas = Array.from(groups.keys()).sort(cmpTH);
  for (const area of areas){
    const topicMap = groups.get(area);

    // ----- Area card -----
    const areaCard = document.createElement('div');
    areaCard.className = 'area-card';

    const theme = getAreaTheme(area);
    areaCard.style.borderColor = theme.bd;

    const head = document.createElement('div');
    head.className = 'area-head flex items-center justify-between';
    head.style.background = theme.bg;
    head.style.color = '#fff';
    head.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="area-chip">A</span>
        <div>
          <div class="font-semibold text-white">Area: ${area || '(ไม่ระบุพื้นที่)'}</div>
          <div class="text-xs text-white/80">Topic: ${topicMap.size}</div>
        </div>
      </div>`;
    areaCard.appendChild(head);

    const body = document.createElement('div');
    body.className = 'p-3 md:p-4 space-y-4';

    const topics = Array.from(topicMap.keys()).sort(cmpTH);
    for (const topic of topics){
      const qmap = topicMap.get(topic);

      const topicBox  = document.createElement('div');
      topicBox.className  = 'rounded-xl border border-slate-200 bg-white/70';

      const topicHead = document.createElement('div');
      topicHead.className = 'px-3 py-2 border-b bg-slate-50/70 rounded-t-xl';
      topicHead.innerHTML = `<div class="font-medium text-slate-800">Topic: ${topic || '-'}</div>`;
      topicBox.appendChild(topicHead);

      const topicBody = document.createElement('div');
      topicBody.className = 'p-2 space-y-4';

      const questions = Array.from(qmap.keys()).sort(cmpTH);
      for (const question of questions){
        const rows = qmap.get(question).slice().sort((a,b)=>cmpTH(a.storeCode, b.storeCode));

        const qBox = document.createElement('div');
qBox.className = 'rounded-lg border border-slate-200 bg-white';
qBox.innerHTML = `
  <div class="px-3 py-2 border-b bg-white rounded-t-lg">
    <div class="text-[13px] text-slate-700">
      <span class="font-semibold">Question:</span> ${question || '-'}
    </div>
  </div>
  <div class="p-2 area-table-wrap">
    <div class="overflow-x-auto -mx-2">
      <table class="min-w-[640px] text-sm">
        <thead class="bg-slate-50 text-slate-700">
          <tr>
            <th class="px-2 py-2 text-left  w-[220px]">Store</th>
            <th class="px-2 py-2 text-center w-[110px]">Round1</th>
            <th class="px-2 py-2 text-center w-[110px]">Round2</th>
            <th class="px-2 py-2 text-center w-[110px]">Round3</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>`;
        const tbody = qBox.querySelector('tbody');

        rows.forEach(row=>{
          const tr = document.createElement('tr');
          const tone = anyYellowRed(row.roundAns);
          if(tone==='red') tr.classList.add('row-red');
          else if(tone==='yellow') tr.classList.add('row-yellow');

          const key = getActionId(row) ? `id:${getActionId(row)}` : `ctx:${row.topic}|${row.question}`;

          tr.innerHTML = `
            <td class="px-2 py-2 align-top">
              <div class="font-semibold">${row.storeCode || ''}</div>
              <div class="text-[11px] text-slate-500">${row.storeName || ''}</div>
              <div class="row-att mt-1" data-att></div>
            </td>
            ${[1,2,3].map(rn=>{
              const ans = row.roundAns[rn];
              const isYR = /yellow|red/i.test(String(ans||''));

              // ✅ ดูสถานะของ "รอบนั้น" ก่อน ถ้าไม่มีค่อยถอยไปใช้ล่าสุด
              const perRoundAct   = row.roundRaw?.[rn]?.action || null;
              const perRoundId    = getActionId(row.roundRaw?.[rn]) || '';
              const latestAct     = row.action || null;
              const actStatus     = perRoundAct?.status ?? latestAct?.status ?? '';
              const isDoneThisRnd = normalizeStatus(actStatus) === 'done';

              const btnHtml = isYR ? `
                <button class="icon-btn" title="${isDoneThisRnd ? 'เสร็จสิ้น (Done)' : 'รายละเอียดรอบ '+rn}" data-plus
                  data-key="${key}"
                  data-refno="${row.roundRaw?.[rn]?.refno||''}"
                  data-topic="${row.topic}" data-question="${row.question}"
                  data-round="${rn}" data-store="${row.storeCode || ''}">
                  ${
                    isDoneThisRnd
                    ? `<svg class="w-4 h-4 text-emerald-600" viewBox="0 0 24 24" fill="none">
                         <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                       </svg>`
                    : `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                         <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                       </svg>`
                  }
                </button>` : ``;

              return `
                <td class="px-2 py-2 align-top text-center">
                  <div class="flex items-center justify-center gap-2">
                    ${pill(ans)}
                    ${btnHtml}
                  </div>
                </td>`;
            }).join('')}
          `;

          // รูปแนบ
          const attHost = tr.querySelector('[data-att]');
          const imgs = [1,2,3]
            .flatMap(rn => (row.roundRaw?.[rn]?.attachments || []).map(a => a.url))
            .filter(Boolean);
          if (attHost) buildRowAttach(attHost, imgs);

          // เปิดโมดัล: ส่ง action/id ของ "รอบที่คลิก" เข้าไปก่อนเสมอ
tr.querySelectorAll('[data-plus]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const rn    = Number(btn.getAttribute('data-round'));
    const key   = btn.getAttribute('data-key');
    const store = btn.getAttribute('data-store') || '';
    const perRoundRaw  = row.roundRaw?.[rn] || {};

    // 🔑 สร้าง changeKey ให้ตรงกับ queueActionChange()
    const changeKey = `${key}|r${rn}|${store}`;
    const pending   = CHANGES.get(changeKey);
    const pendingAction = pending?.action || null;

    const ctx = {
      refno: perRoundRaw.refno || '',
      key,
      topic: btn.getAttribute('data-topic'),
      question: btn.getAttribute('data-question'),
      storeCode: store,

      actionid: getActionId(perRoundRaw) || getActionId(row) || null,
      round: rn,

      // ⬅️ ถ้ามี pending ใน CHANGES ให้ใช้ก่อน
      currentAction: pendingAction || perRoundRaw.action || row.action || {},
      currentComment: perRoundRaw.comment || ''
    };

    openActionModal(ctx);
  });
});


          tbody.appendChild(tr);
        });

        topicBody.appendChild(qBox);
      }

      topicBox.appendChild(topicBody);
      body.appendChild(topicBox);
    }

    areaCard.appendChild(body);
    host.appendChild(areaCard);
  }
}

/* ========= NAV & SIDEBAR ========= */
/* ========= NAV & SIDEBAR ========= */
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.onclick = ()=> setActiveTab(btn.dataset.tab);
});

const sidebar = qs('sidebar');
const overlay = qs('sbOverlay');

function closeActionModalSafe(){
  const m = qs('actionModal');
  if (m) { m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
}

function openSidebar(){
  closeActionModalSafe();
  sidebar.classList.add('open');
  overlay.classList.add('show');
  document.body.classList.add('overflow-hidden');
}
function closeSidebar(){
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
  document.body.classList.remove('overflow-hidden');
}

qs('btnHamburger')?.addEventListener('click', ()=>{
  if (window.innerWidth <= 1024){
    if (sidebar.classList.contains('open')) closeSidebar();
    else openSidebar();
  } else {
    // เดสก์ท็อป: โหมดหุบ sidebar
    sidebar.classList.toggle('closed');
  }
});
overlay?.addEventListener('click', closeSidebar);
window.addEventListener('resize', ()=>{ if (window.innerWidth > 1024) closeSidebar(); });

/* ========= SAVE BAR (optional batch) ========= */
function refreshDirty(){
  const n = CHANGES.size;
  qs('dirtyCount').textContent = n;
  show(qs('saveBar'), n>0);
  const topBtn = qs('btnSaveAllTop'); topBtn.disabled = n===0; topBtn.classList.toggle('opacity-40', n===0);
}
qs('btnSaveAllTop').onclick = ()=> qs('btnSaveAll').click();
qs('btnSaveAll').onclick = async ()=>{
  if(!CHANGES.size) return;
  loading(true);
  const nBefore = CHANGES.size;
  try{
    for(const [_, payload] of CHANGES){
      const rsp = await apiPost('action_update', payload);
      if(!rsp.ok) throw new Error(rsp.error||'บันทึกไม่สำเร็จ');
    }
    CHANGES.clear(); refreshDirty();
    await loadEvaluations();
    qs('lastSaved').textContent = `บันทึกล่าสุด ${new Date().toLocaleString('th-TH')}`;
    showSuccess(nBefore);
  }catch(ex){ alert(ex.message); }
  finally{ loading(false); }
};

function showSuccess(n){
  qs('succ_count').textContent = n;
  qs('saveSuccess').classList.remove('hidden');
}
qs('succ_close')?.addEventListener('click', ()=> qs('saveSuccess').classList.add('hidden'));


/* ========= EXPORT ========= */
(() => {
  const btn = qs('btnExport');
  const menu = qs('exportMenu');
  if (!btn || !menu) return; // ไม่มีปุ่ม/เมนู ก็ไม่ต้อง bind อะไร

  btn.addEventListener('click', () => {
    menu.classList.toggle('hidden');
  });

  document.addEventListener('click', (e) => {
    const t = e.target;
    // คลิกนอกเมนูและไม่ใช่ปุ่ม -> ซ่อนเมนู
    if (!t.closest('#exportMenu') && !t.closest('#btnExport')) {
      menu.classList.add('hidden');
    }
  });

  menu.addEventListener('click', (e) => {
    const t = e.target.closest('button[data-export]');
    if (!t) return;
    const act = t.dataset.export;
    menu.classList.add('hidden');

    if (act === 'print') {
      window.print();
    } else if (act === 'csv') {
      exportCSVCurrent();
    } else if (act === 'excel') {
      exportExcelPretty();
     } else if (act === 'import') {
    const input = document.getElementById('excelInput');
    if (!input) { alert('ไม่พบ #excelInput'); return; }
    input.click(); // เปิด file picker
  }
 });
})();

// ================== CSV ==================

function toCSVWithHeaders(headers, rows){
  // headers: [{ header:'Action ID', key:'actionid' }, ...]
  const esc = s => `"${String(s ?? '').replace(/"/g,'""')}"`;
  const headLine = headers.map(h => esc(h.header)).join(',');
  const body = rows.map(r => headers.map(h => esc(r[h.key])).join(',')).join('\n');
  return headLine + '\n' + body;
}

// ===== 2) Export CSV (ตามลำดับ/ชื่อคอลัมน์ใหม่) =====
const EXPORT_HEADERS = [
  'refno','round','storeCode','storeName','area','topic','question','answer',
  'actionid','assign','action','reason','status','dueDate'
];

// build rows for export (mode kept for compatibility)
function buildExportRows(mode='per-round'){
  const rows = [];

  // safe date formatter: prefer global toISODate if present, otherwise minimal fallback
  const fmt = (v) => {
    if (typeof toISODate === 'function') return toISODate(v);
    if (v === null || v === undefined || v === '') return '';
    if (v instanceof Date && !isNaN(v)) return v.toISOString().slice(0,10);
    const s = String(v).trim();
    if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
    if (/^\d{2}\/\d{2}\/\d{4}/.test(s)) {
      // dd/mm/yyyy -> yyyy-mm-dd (basic)
      const [d,m,y] = s.split('/');
      return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    }
    const d2 = new Date(s);
    return isNaN(d2) ? '' : d2.toISOString().slice(0,10);
  };

  for (const it of ALL_ITEMS || []) {
    const action = it.action || {};
    const aid = getActionId(it);
    rows.push({
      refno: it.refno ?? it.ref_no ?? '',
      round: it.round ?? '',
      storeCode: it.storeCode ?? it.store_code ?? it.store ?? '',
      storeName: it.storeName ?? it.store_name ?? it.storeNameThai ?? '',
      area: it.area ?? '',
      topic: it.topic ?? it.topic_name ?? '',
      question: it.question ?? it.question_text ?? it.q ?? '',
      answer: it.answer ?? it.result ?? '',
      actionid: aid,
      assign: action.assign ?? action.assignee ?? action.bu ?? it.assign ?? '',
      action: action.text ?? action.action ?? it.actionText ?? '',
      reason: action.reason ?? it.reason ?? '',
      status: action.status ?? it.status ?? '',
      dueDate: fmt(action.dueDate ?? action.due_date ?? action.due ?? it.dueDate ?? it.action_due_date ?? '')
    });
  }
  return rows;
}

function escapeCsvCell(v){
  if (v == null) return '';
  const s = String(v);
  if (/[",\r\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

function toCSVOrdered(rows, headers=EXPORT_HEADERS){
  const lines = [];
  lines.push(headers.join(','));
  for (const r of rows){
    const cols = headers.map(h => escapeCsvCell(r[h] ?? ''));
    lines.push(cols.join(','));
  }
  return lines.join('\r\n');
}

// ====== Export CSV ======
function exportCSVCurrent({ mode='per-round' } = {}){
  const rows = buildExportRows(mode);
  const csv  = '\ufeff' + toCSVOrdered(rows); // BOM สำหรับ Excel/Windows
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = `site-store-${mode}-${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ====== Export Excel (สวย + สี + Freeze header) ======
async function exportExcelPretty({ mode='per-round' } = {}) {
  if (typeof ExcelJS === 'undefined') throw new Error('ExcelJS ไม่ได้ถูกโหลด');
  const rows = buildExportRows(mode);
  if (!Array.isArray(rows) || rows.length === 0) throw new Error('ไม่มีข้อมูลสำหรับส่งออก');

  const headers = Array.isArray(EXPORT_HEADERS) && EXPORT_HEADERS.length ? EXPORT_HEADERS.slice() : Object.keys(rows[0]);

  const wb = new ExcelJS.Workbook();
  const ws = wb.addWorksheet('Sheet1');

  // define columns so ExcelJS maps object keys to cells
  ws.columns = headers.map(h => ({ header: h, key: h, width: Math.max(12, Math.min(40, String(h).length + 8)) }));

  // ensure every row has all header keys (no undefined)
  ws.addRows(rows.map(r => {
    const obj = {};
    for (const h of headers) obj[h] = (r[h] != null) ? r[h] : '';
    return obj;
  }));

  // header style + freeze
  const headerRow = ws.getRow(1);
  headerRow.font = { bold:true };
  headerRow.alignment = { vertical:'middle', horizontal:'center' };
  ws.views = [{ state:'frozen', ySplit:1 }];

  // auto-filter safe (uses defined columns)
  ws.autoFilter = { from: 'A1', to: ws.getCell(1, ws.columnCount).address };

  const buf = await wb.xlsx.writeBuffer();
  const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  saveAs(blob, `site-store-${mode}-${Date.now()}.xlsx`);
}

// ================== IMPORT (Excel → Supabase) ==================
async function importActionsXlsxToSupabase(
  fileOrBlob,
  { supabaseUrl, supabaseKey, tableName='SITESTORE', chunkSize=40, dryRun=false } = {}
){
  if (typeof ExcelJS === 'undefined') {
    throw new Error('ExcelJS ไม่ได้ถูกโหลด');
  }
  if (typeof window !== 'undefined' && typeof window.supabase === 'undefined') {
    throw new Error('supabase-js ไม่ได้ถูกโหลด');
  }
  if (!supabaseUrl || !supabaseKey) {
    throw new Error('กรุณาระบุ supabaseUrl และ supabaseKey');
  }

  const sb = window.supabase.createClient(supabaseUrl, supabaseKey, {
    auth: { persistSession: false }
  });

  const lc = s => String(s ?? '').trim().toLowerCase();
  const normBU = (s) => {
    const v = lc(s);
    if (!v) return '';
    if (v === 'opr' || v === 'operation' || v === 'operations') return 'Operation';
    if (v === 'hr') return 'HR';
    if (v === 'it') return 'IT';
    if (v === 'qa' || v === 'quality') return 'QA';
    if (v === 'finance' || v === 'fin') return 'Finance';
    if (v === 'safety' || v === 'ohs') return 'Safety';
    return s.charAt(0).toUpperCase() + s.slice(1);
  };
  const normStatus = (s) => {
    const v = lc(s);
    if (!v) return '';
    if (v === 'done') return 'Done';
    if (v === 'in progress' || v === 'inprogress' || v === 'progress') return 'In progress';
    if (v === 'sent' || v === 'sent bu' || v === 'sent to bu') return 'Sent BU';
    return s.trim();
  };
  const toISODate = (x) => {
    if (!x && x !== 0) return '';
    if (x instanceof Date && !isNaN(x)) {
      const y = x.getFullYear();
      const m = String(x.getMonth()+1).padStart(2,'0');
      const d = String(x.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    if (typeof x === 'number' && isFinite(x)) {
      const excelEpoch = new Date(1899, 11, 30);
      const ms = x * 86400000;
      const dt = new Date(excelEpoch.getTime() + ms);
      return isNaN(dt) ? '' : toISODate(dt);
    }
    const s = String(x).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    if (/^\d{4}\/\d{2}\/\d{2}$/.test(s)) return s.replace(/\//g,'-');
    const d2 = new Date(s);
    return isNaN(d2) ? '' : toISODate(d2);
  };
  const same = (a,b) => (a ?? null) === (b ?? null);
  const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

  const wb = new ExcelJS.Workbook();
  const buffer = fileOrBlob instanceof ArrayBuffer
    ? fileOrBlob
    : (fileOrBlob.arrayBuffer ? await fileOrBlob.arrayBuffer() : await fileOrBlob.blob().arrayBuffer());
  await wb.xlsx.load(buffer);
  const ws = wb.worksheets[0];
  if (!ws) throw new Error('ไม่พบ worksheet แรกในไฟล์');

  const headerIndex = (row) => {
    const map = {};
    row.eachCell((cell, col) => {
      const name = lc(String(cell.value||'').replace(/\s+/g,'').replace(/_/g,'')); 
      if (name) map[name] = col;
    });
    if (!map.actionid) throw new Error('ไม่พบคอลัมน์ "actionid" ในไฟล์ Excel');
    const req = ['reason','action','bu','duedate','actionstatus'];
    const miss = req.filter(k => !(k in map));
    if (miss.length) throw new Error('หัวคอลัมน์หายไป: ' + miss.join(', '));
    return map;
  };

  const H = headerIndex(ws.getRow(1));

  const rawRows = [];
  for (let r=2; r<=ws.rowCount; r++){
    const row = ws.getRow(r);
    const get = (key) => {
      const col = H[key]; if (!col) return '';
      const v = row.getCell(col)?.value;
      return (v && typeof v === 'object' && 'text' in v) ? String(v.text) : v;
    };
    const actionid  = String(get('actionid') ?? '').trim();
    const reason    = String(get('reason') ?? '').trim();
    const actionTxt = String(get('action') ?? '').trim();
    const bu        = normBU(get('bu'));
    const status    = normStatus(get('actionstatus'));
    const due       = toISODate(get('duedate'));

    if (!actionid) continue; // ไม่มีคีย์ -> ข้าม
    rawRows.push({ _excelRow:r, actionid, reason, actionTxt, bu, status, due });
  }
  if (!rawRows.length) {
    return { ok:false, summary:{ total:0 }, detail:[], message:'ไม่พบข้อมูลสำหรับอัปเดตในไฟล์' };
  }

  // ดึงค่าเดิมมาเทียบ (ลดงานอัปเดตซ้ำ)
  const uniqIds = Array.from(new Set(rawRows.map(x=>x.actionid)));
  const existingMap = new Map();
  for (let i=0;i<uniqIds.length;i+=1000) {
    const part = uniqIds.slice(i,i+1000);
    const { data, error } = await sb
      .from(tableName)
      .select('actionid, action_reason, action_text, action_bu, action_due_date, action_status')
      .in('actionid', part);
    if (error) throw new Error('ดึงข้อมูลเดิมล้มเหลว: ' + (error.message||error));
    (data||[]).forEach(r => existingMap.set(String(r.actionid), r));
  }

  const plan = [], skipped = [], errors = [];
  for (const rr of rawRows) {
    const cur = existingMap.get(rr.aactionid);
    if (!cur) { skipped.push({ row: rr._excelRow, actionid: rr.actionid, reason:'ไม่พบ actionid ในฐานข้อมูล' }); continue; }
    if (!rr.reason) { errors.push({ row: rr._excelRow, actionid: rr.actionid, error:'reason ว่าง' }); continue; }
    if (!rr.bu)     { errors.push({ row: rr._excelRow, actionid: rr.actionid, error:'bu ว่าง' }); continue; }
    const allowActionText = (rr.bu === 'Operation' && rr.status !== 'Sent BU');
    const nextActionText  = allowActionText ? (rr.actionTxt || null) : null;
    const nextDue = rr.due ? rr.due : null;
    if (rr.due && !/^\d{4}-\d{2}-\d{2}$/.test(rr.due)) {
      errors.push({ row: rr._excelRow, actionid: rr.actionid, error:'duedate ไม่ใช่รูปแบบ YYYY-MM-DD' }); continue;
    }

    const will = {
      actionid       : rr.actionid,
      action_reason   : rr.reason,
      action_text     : nextActionText,
      action_bu       : rr.bu,
      action_status   : rr.status,
      action_due_date : nextDue
    };
    const old = {
      action_reason   : cur.action_reason ?? null,
      action_text     : cur.action_text ?? null,
      action_bu       : cur.action_bu ?? null,
      action_status   : cur.action_status ?? null,
      action_due_date : cur.action_due_date ?? null
    };

    const eq =
      same(will.action_reason, old.action_reason) &&
      same(will.action_text,   old.action_text)   &&
      same(will.action_bu,     old.action_bu)     &&
      same(will.action_status, old.action_status) &&
      same(will.action_due_date, old.action_due_date);

    if (eq) { skipped.push({ row: rr._excelRow, actionid: rr.actionid, reason:'ไม่มีการเปลี่ยนแปลง' }); continue; }
    plan.push({ row: rr._excelRow, update: will });
  }

  if (!plan.length && !errors.length) {
    return { ok:true, summary:{ total: rawRows.length, planned:0, updated:0, skipped: skipped.length, errors:0 }, detail: skipped };
  }

  const updateOne = async (obj) => {
    if (dryRun) return { ok:true, updated:0, dryRun:true };
    const { data, error } = await sb
      .from(tableName)
      .update({
        action_reason    : obj.action_reason,
        action_text      : obj.action_text,
        action_bu        : obj.action_bu,
        action_status    : obj.action_status,
        action_due_date  : obj.action_due_date
      })
      .eq('actionid', obj.actionid)
      .select('actionid');
    if (error) return { ok:false, error };
    return { ok:true, updated:(data?.length||0) };
  };

  let updated = 0; const failures = [];
  for (let i=0;i<plan.length;i+=chunkSize){
    const bucket = plan.slice(i,i+chunkSize);
    for (const job of bucket) {
      const res = await updateOne(job.update);
      if (res.ok && res.updated > 0) updated += res.updated;
      else if (res.ok && res.updated === 0) failures.push({ row: job.row, actionid: job.update.actionid, error:'ไม่พบแถวให้ update' });
      else failures.push({ row: job.row, actionid: job.update.actionid, error: res.error?.message || String(res.error) });
      await sleep(10);
    }
    await sleep(60);
  }

  return {
    ok: failures.length === 0 && errors.length === 0,
    summary: { total: rawRows.length, planned: plan.length, updated, skipped: skipped.length, errors: errors.length + failures.length },
    detail:  [
      ...skipped.map(x => ({ type:'skipped', ...x })),
      ...errors.map(x => ({ type:'invalid', ...x })),
      ...failures.map(x => ({ type:'failed',  ...x }))
    ]
  };
}

// ======= Hook input file ถ้ามี =======
(() => {
  const input = document.getElementById('excelInput');
  if (!input) return; // ยังไม่มีช่องไฟล์ก็ข้ามไปก่อน
  input.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try{
      const result = await importActionsXlsxToSupabase(file, {
        supabaseUrl: 'https://iodmkpvgrvlpiydurimv.supabase.co',
        supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZG1rcHZncnZscGl5ZHVyaW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MTE5MDksImV4cCI6MjA3MzQ4NzkwOX0.8lGDPEnViaLBY0mDf2IfsfwGI8qBFO7G01tC_BnR3cs',
        tableName: 'SITESTORE',
        chunkSize: 40,
        dryRun: false
      });
      console.log(result.summary, result.detail);
      alert(
        `อัปเดตสำเร็จ: ${result.summary.updated} / วางแผน: ${result.summary.planned}\n` +
        `ข้าม: ${result.summary.skipped} ผิดพลาด: ${result.summary.errors}`
      );
    }catch(ex){
      alert(ex.message || String(ex));
    }finally{
      // ล้างค่าเพื่ออนุญาตเลือกไฟล์เดิมได้อีกครั้ง
      e.target.value = '';
    }
  });
})();
</script>
</body>
</html>










